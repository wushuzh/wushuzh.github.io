<!DOCTYPE html>
<html lang="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>内核恐慌，咋整？</title>
<meta name="description" content="个人技术站点">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://wushuzh.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://wushuzh.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.theme.css">


  <link href="https://wushuzh.github.io/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://wushuzh.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://wushuzh.github.io/img/favicon.png">


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-102509506-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="/">小强会武术</a></h1>
    
      <p class="sidebar-p">工程师</p>
    
      <p class="sidebar-p">记录每一个自己填平的坑</p>
    
    <ul class="sidebar-menu">
      
      
        <li><a href="https://wushuzh.github.io/">Home</a></li>
      
    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/Xiao_Qiang" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  <a href="mailto:wushuzh@outlook.com" data-animate-hover="pulse" class="email">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  
  

  
  <a href="https://wushuzh.github.io/index.xml" data-animate-hover="pulse">
    <i class='fa fa-rss'></i>
  </a>
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2017 wushuzh
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="/">小强会武术</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">

      <div class="row">
        <div class="col-sm-6">
          
            <div class="image">
              <img src="https://wushuzh.github.io//img/blog/deal-with-kernel-panic/dead-comp.jpg" class="img-responsive" alt="">
            </div>
          
        </div>
        <div class="col-md-6">
            <h2>内核恐慌，咋整？</h2>
                <p>
                  小强会武术
                </p>

                <time datetime="2017-06-26 22:31:22 &#43;0800 CST">
                <i class="fa fa-calendar-o fa-fw"></i> 2017-06-26
                </time>
                &middot;
                1123 字
                &middot;
                3 分钟

        </div>
      </div>
      <br />

         <p>Kernel Panic 才能撑起&rdquo;咋整&rdquo;系列开篇的门面。
</p>

<h3 id="前言">前言</h3>

<p>《咋整》是在工作中，同学们遇到各式问题的案例汇总。之所以开一个系列写下来，一方面是因为有些问题很典型，今后还可能出现，一方面也是因为有些问题确实诡异，我也第一次见。一开始在公众号发出来时起的名是“活久见”系列。</p>

<h3 id="现象分析">现象分析</h3>

<p>开篇的一个报错是——“内核恐慌”。</p>

<p>缘起是 Lucy 同学执行了一个貌似是查看系统负荷检测的脚本，但其中却包含了 rpm 的安装指令。没有然后，服务器直接挂掉：</p>

<ul>
<li>现象1：当前已打开的会话，执行任何指令都会报错，relocation error</li>
<li>现象2：无法登入新用户，再重启系统后，直接挂起，直接显示 kernel panic</li>
</ul>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">/bin/login: relocation error: /usr/lib64/libc.so.6:
    symbol _ dl_starting_up, version GLIBC_PRIVATE not defined
    in file ld-linux-x86-64.so.2 with link time reference</code></pre></div>

<figure>
    
        <img src="/img/blog/deal-with-kernel-panic/panic-snap.png" />
    
    
    <figcaption>
        <h4>Kernel Panic at Boot</h4>
        
    </figcaption>
    
</figure>
</p>

<h3 id="处理过程">处理过程</h3>

<p>折腾一番，基本解决，简单记录一下：</p>

<ol>
<li>在 RedHat 知识库中找到了一个几乎一模一样报错信息，并且<a href="https://access.redhat.com/solutions/1475913">解决方案</a>已被标记为验证通过；</li>
<li>下载一个光盘镜像，通过服务器的远程管理，挂载ISO，并通过其引导系统；</li>
<li>进入救援模式，查看环境，并对问题系统的关键目录文件截屏截图；</li>
<li>执行第一条命令  chroot 时，不成功，依然报之前 relocation error 错误信息，看来此问题和知识库中找到的并不完全一样；</li>
<li>跳过 chroot 直接到 /mnt/sysimage 下进行相关和新近文件进行各种移动及备份实验，截屏所有操作；</li>
<li>错误信息最终转为找不到库函数文件，修复链接，重启后系统恢复</li>
</ol>

<p>这里第五步稍微复杂些，有点像法医探伤，一般的方法就是阅读直接相关的脚本程序，查看相关 rpm 包中文件内容，和其他正常系统文件做比对，经过多轮猜测和尝试，最终你就一定能靠运气修好系统( 逃…… )</p>


<figure>
    
        <img src="/img/blog/deal-with-kernel-panic/centos-7-rescue-2.png" />
    
    
    <figcaption>
        <h4>chroot</h4>
        
    </figcaption>
    
</figure>


<h3 id="伴生知识">伴生知识</h3>

<p>另外就是要了解一些不太常用的命令，知道去哪里查找就行：</p>

<ul>
<li>查看一个 rpm 文件中的原数据 <code>rpm -qip file.rpm</code></li>
<li>查看一个 rpm 文件中的文件 <code>rpm -qlpv file.rpm</code></li>
<li>提取一个 rpm 文件中所有的文件 <code>rpm2cpio file.rpm | cpio -idmv</code></li>
<li>查看 rpm 中预安装和后安装脚本内容 <code>rpm -qp --scripts file.rpm</code></li>
<li>查看 rpm 中 spec 文件中关于安装过程的文件拷贝及权限设置等等，参考 Stackoverflow <a href="https://stackoverflow.com/a/14168474">extract the spec file from rpm package</a></li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">// rpmrebuild is available in EPEL repo
rpmrebuild -s pkg.spec installed-pkg
rpmrebuild -e -p pkg.rpm</code></pre></div>

<h3 id="事后总结">事后总结</h3>

<p>最后是由表及里的经验总结：</p>

<ol>
<li>就算内核恐慌，自己也不用慌，尤其当你使用的是 RedHat 的时候，这通常意味着你使用的版本已落后了 8 - 10 年，所以你不会是第一个遇到此问题的倒霉蛋，利用好搜索引擎，操作时保留所有截屏及日志，方便之后问题回溯或上报。如果你有一个 RedHat 的订阅账户，优先在其知识库中查找，讨论，甚至要求技术支持</li>
<li>对开发软件的同学，尽量不要将工具的安装和执行混在一起，不得不这么做的时候，就要同时操作提示和环境检测，在业务需求、易用性、合规运维三方面做好平衡；</li>
<li>对拥有 sudo 权限或 root 密码的同学，一个重要的心理建设就是不能想当然，执行前要对来源不明的脚本做审核——记住蜘蛛侠他爷爷说的，能力越大，责任越大；</li>
</ol>


<figure>
    
        <img src="/img/blog/deal-with-kernel-panic/spiderman.jpg" />
    
    
    <figcaption>
        <h4>There must also come Great Responsibility</h4>
        
    </figcaption>
    
</figure>


<p>参考文档</p>

<blockquote>
<ul>
<li>Redhat Knowledge Base <a href="https://access.redhat.com/solutions/770703">How to boot a system into rescue mode</a></li>
<li>packagecloud blog (2015-10-13) <a href="https://blog.packagecloud.io/eng/2015/10/13/inspect-extract-contents-rpm-packages/">Inspecting and extracting RPM package contents</a></li>
<li><a href="https://fedoraproject.org/wiki/Packaging:Scriptlets">Fedora Packaging Guidelines for RPM Scriptlets</a></li>
</ul>
</blockquote>

<p>封面图片来自 <a href="https://dribbble.com/shots/538431-Dead-Computer">Dead Computer</a> <a href="https://dribbble.com/doe_eyed"><i class="fa fa-dribbble" aria-hidden="true"></i> Eric Nyffeler</a></p>

<p>其他图片来源网络</p>
         <div id="disqus_thread">
  <a href="#" onclick="disqus();return false;">enable VPN and click here to <i class="fa fa-comments" aria-hidden="true"></i></a>
</div>

<script type="text/javascript">
var disqus_loaded = false;
function disqus() {
  if (!disqus_loaded) {
    
    
    
    

    disqus_loaded = true;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'wushuzh';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
};
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</div>
<noscript>
  <style>.jsonly { display: none }</style>
</noscript>

          </div>
      </div>
  </div>
  <script src="https://wushuzh.github.io/js/jquery.min.js"></script>
<script src="https://wushuzh.github.io/js/bootstrap.min.js"></script>
<script src="https://wushuzh.github.io/js/jquery.cookie.js"> </script>
<script src="https://wushuzh.github.io/js/ekko-lightbox.js"></script>
<script src="https://wushuzh.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://wushuzh.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/owl.carousel.min.js"></script>
<script src="https://wushuzh.github.io/js/front.js"></script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
