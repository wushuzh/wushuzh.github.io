<!DOCTYPE html>
<html lang="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>看不懂报错，咋整？</title>
<meta name="description" content="个人技术站点">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://wushuzh.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://wushuzh.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.theme.css">


  <link href="https://wushuzh.github.io/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://wushuzh.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://wushuzh.github.io/img/favicon.png">


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-102509506-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              
              
<div class="col-xs-12 col-sm-12 col-md-12 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="https://wushuzh.github.io/">小强会武术</a></h1>
</div>

  <div class="row">
    <div class="col-lg-10 col-lg-offset-1">
      <div class="content-column-content">
      
      <div class="row">
        <div class="col-sm-4">
          
            <div class="image">
              <img src="https://wushuzh.github.io//img/blog/deal-with-wired-errmsgs/pc-gone-2.png" class="img-responsive" alt="">
            </div>
          
        </div>
        <div class="col-md-6">
            <h2>看不懂报错，咋整？</h2>
                <p>
                  <i class="fa fa-share-square-o fa-fw"></i><a href="/"> 小强会武术</a>
                </p>

                <p>
                <time datetime="2017-06-30 19:19:19 &#43;0800 CST">
                <i class="fa fa-calendar-o fa-fw"></i> 2017-06-30
                </time>
                &middot;
                1477 字
                &middot;
                3 分钟
                </p>

                
                <p>
                  <i class="fa fa-tags fa-fw" aria-hidden="true"></i>
                  <a href="/tags/virtualization">virtualization</a> &nbsp;&nbsp; <a href="/tags/linux">linux</a>
                </p>
                

        </div>
      </div>
      <br />

         <p>追踪本质，别被报错信息带歪了方向……
</p>

<h3 id="现象分析">现象分析</h3>

<p>Lucy 的服务器才从内核恐慌中恢复过来，接着创建虚拟机的时候，出现错误，对应报错信息邮件转发如下：</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">```
Traceback (most recent call last):
  File &#34;/usr/share/virt-manager/virtManager/asyncjob.py&#34;, line 44,
    in cb_wrapper callback(asyncjob, *args, **kwargs)
  File &#34;/usr/share/virt-manager/virtManager/create.py&#34;, line 1932,
    in do_install guest.start_install(False, meter=meter)
  File &#34;/usr/lib/python2.6/site-packages/virtinst/Guest.py&#34;, line 1229,
    in start_install noboot)
  File &#34;/usr/lib/python2.6/site-packages/virtinst/Guest.py&#34;, line 1297,
    in _create_guest dom = self.conn.createLinux(start_xml or final_xml, 0)
  File &#34;/usr/lib64/python2.6/site-packages/libvirt.py&#34;, line 2686,
    in createLinux if ret is None:
      raise libvirtError(&#39;virDomainCreateLinux() failed&#39;, conn=self)
libvirtError: Unable to read from monitor: Connection reset by peer
```</code></pre></div>

<p>服务器是一台 KVM 宿主服务器，virsh 查看正在运行的虚拟机一切正常。Lucy 并没说安装那台机器，<strong>但查问题总需要一个问题重现步骤</strong> ，好在通过 kickstart 创建安装一台虚拟机也不麻烦，直接试一下。下面的步骤将触发一个标准的 kickstart 安装，并将安装过程直接输出到终端，供用户监控安装过程。</p>

<h3 id="尝试问题重现">尝试问题重现</h3>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">qemu-img create -f qcow2 wushuzh.qcow2 10G

<span style="color:#75715e"># prepare a kickstart file, a few notes:
</span><span style="color:#75715e">#  1. set cdrom as the installation media
</span><span style="color:#75715e">#  2. set text so no vnc/gui is needed
</span><span style="color:#75715e">#  3. use dhcp for network (activate) , set local ntp
</span><span style="color:#75715e">#  4. set hostname and crypted passwd of root
</span><span style="color:#75715e">#  5. use autopart and minimal installation to speed up progress
</span><span style="color:#75715e"></span>
virt-install --name wushuzh  --vcpus<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --ram <span style="color:#ae81ff">4096</span> <span style="color:#ae81ff">\</span>
  --os-type<span style="color:#f92672">=</span>linux --os-variant rhel7 <span style="color:#ae81ff">\</span>
  --disk /kvm/vmimg/wushuzh.qcow2,device<span style="color:#f92672">=</span>disk,bus<span style="color:#f92672">=</span>virtio <span style="color:#ae81ff">\</span>
  --location /repo/isos/rhel-server-7.3-x86_64-dvd.iso <span style="color:#ae81ff">\</span>
  --extra-args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ks=file:/wushuzh.ks console=tty0 console=ttyS0,115200n8&#34;</span> <span style="color:#ae81ff">\</span>
  --network network:default --initrd-inject<span style="color:#f92672">=</span>wushuzh.ks  --nographics</code></pre></div>

<p>结果安装一切顺利，虚拟机成功启动。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># consider add this into /etc/profile
</span><span style="color:#75715e"></span>export LIBVIRT_DEFAULT_URI<span style="color:#f92672">=</span>qemu:///system

virsh console wushuzh</code></pre></div>

<h3 id="深入查找日志">深入查找日志</h3>

<p>可以断定，这台服务器上的基本 libvirtd 服务没问题。产生问题可能来自不当的配置执行，或是特定的环境设置。</p>

<p>本文开头的报错信息确实没什么用，看不出是哪台虚拟机报错，如何创建的。网上查了一下类似的报错，比如<a href="https://bugs.launchpad.net/nova/+bug/1255624">这个</a>，建议查看 <code>/var/log/libvirt/qemu/$GUESTNAME.log</code> 中具体的日志。</p>

<p>带着这个信息，去问了下 Lucy ，观看了一下她的操作过程：通过 virt-manager 图形界面安装服务器。全部配置完成，在最后点击安装的时候，界面出现了错误。赶快去看一下相应的 libvirt 日志。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">[root@kvmhost qemu]# tail -4 some-vmname.log
Domain id=28 is tainted: host-cpu
char device redirected to /dev/pts/11
2017-06-28T05:57:05.872745Z qemu-kvm:
  -drive file=/some-base-folder/some-iso,
    if=none,media=cdrom,id=drive-ide0-1-0,readonly=on,format=raw:
  could not open disk image /some-base-folder/some-iso: Permission denied
2017-06-28 05:57:06.188+0000: shutting down</code></pre></div>

<p>权限有问题，继续查看 /var/log/message 或 security，果然也有相应错误。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">[root@kvmhost log]# tail -3 /var/log/messages
Jun 28 13:57:13 kvmhost setroubleshoot:
  SELinux is preventing /usr/libexec/qemu-kvm from read access
    on the lnk_file releases. For complete SELinux messages.
      run sealert -l ccc9f19d-f2b2-4a1e-b991-af6de737f285</code></pre></div>

<p>这个错误由 selinux 导致，但这个设置在最初搭建此服务器的时候，创建第一台虚拟机的时候遇到过——selinux认为安装介质通过含有 link 的目录进行应用会产生潜在的安全问题——但当时我就添加了相应规则。但这次又一次出现，猜测可能是之前替换系统文件或 rpm 安装包，由此产生的非常规更新导致？</p>

<p>保险起见，又去查看了 <code>/some-base-folder/some-iso</code> 的权限，以及用 lsof 和 fuser 查看是否有其他用户和进程也在使用该文件，都没查到明显的问题。</p>

<p>这个错误的修复也很简单。root 按照日志中建议为本地建立放行规则即可。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">[root@kvmhost log]# sealert -l ccc9f19d-f2b2-4a1e-b991-af6de737f285
PuTTY X11 proxy: Unsupported authorisation protocol
SELinux is preventing /usr/libexec/qemu-kvm from read access
  on the lnk_file some-folder.

*****  Plugin catchall_labels (83.8 confidence) suggests  **********

If you want to allow qemu-kvm to have read access on the releases lnk_file
Then you need to change the label on releases
Do
# semanage fcontext -a -t FILE_TYPE &#39;releases&#39;
where FILE_TYPE is one of the following: proc_t, mnt_t, usr_t,
user_home_type, virt_etc_rw_t, textrel_shlib_t, rpm_script_tmp_t,
home_root_t, configfile, user_home_dir_t, cert_type, device_t,
configfile, sysfs_t, sssd_var_lib_t, virt_var_lib_t, virt_var_run_t,
svirt_t, qemu_var_run_t, svirt_tmp_t, virt_content_t, public_content_t,
public_content_rw_t, device_t, abrt_t, etc_t, ld_so_t, proc_t,
lib_t, sysfs_t, root_t, svirt_image_t, svirt_tmpfs_t, virt_image_t,
user_home_t, usr_t, base_ro_file_type, userdomain, device_t, devlog_t,
locale_t, etc_t, bin_t, sysfs_t, sysfs_t, usbfs_t.
Then execute:
restorecon -v &#39;some-folder&#39;

*****  Plugin catchall (17.1 confidence) suggests  *****************

If you believe that qemu-kvm should be allowed read access
  on the some-folder lnk_file by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access for now by executing:
# grep qemu-kvm /var/log/audit/audit.log | audit2allow -M mypol
# semodule -i mypol.pp

Additional Information:
Source Context                system_u:system_r:svirt_t:s0:c282,c505
Target Context                system_u:object_r:default_t:s0
Target Objects                releases [ lnk_file ]
Source                        qemu-kvm
Source Path                   /usr/libexec/qemu-kvm
Port                          &lt;Unknown&gt;
Host                          nio136
Source RPM Packages           qemu-kvm-0.12.1.2-2.503.el6_9.3.x86_64
Target RPM Packages
Policy RPM                    selinux-policy-3.7.19-307.el6.noarch
Selinux Enabled               True
Policy Type                   targeted
Enforcing Mode                Enforcing
Host Name                     kvmhost
Platform                      Linux kvmhost kernel version etc
Alert Count                   2
First Seen                    Wed 28 Jun 2017 01:57:05 PM CST
Last Seen                     Wed 28 Jun 2017 01:57:05 PM CST
Local ID                      ccc9f19d-f2b2-4a1e-b991-af6de737f285

Raw Audit Messages
type=AVC msg=audit(1498629425.872:3540): avc:  
denied  { read } for  pid=11332 comm=&#34;qemu-kvm&#34; name=&#34;some-folder&#34;
dev=sdd3 ino=1572866
  scontext=system_u:system_r:svirt_t:s0:c282,c505
  tcontext=system_u:object_r:default_t:s0 tclass=lnk_file

type=SYSCALL msg=audit(1498629425.872:3540): arch=x86_64 syscall=open
 success=no exit=EACCES a0=7f255606c6c0 a1=81000 a2=0 a3=40 items=0
 ppid=1 pid=11332 auid=4294967295 uid=107 gid=107 euid=107 suid=107
 fsuid=107 egid=107 sgid=107 fsgid=107 tty=(none) ses=4294967295
 comm=qemu-kvm exe=/usr/libexec/qemu-kvm
   subj=system_u:system_r:svirt_t:s0:c282,c505 key=(null)

Hash: qemu-kvm,svirt_t,default_t,lnk_file,read

audit2allow

#============= svirt_t ==============
allow svirt_t default_t:lnk_file read;

audit2allow -R

#============= svirt_t ==============
allow svirt_t default_t:lnk_file read;</code></pre></div>

<p>最后查看一下安装中 ks 文件 nfs 共享是否依然生效。<code>showmount -e localhost</code> 更多参见 <a href="http://cn.linux.vbird.org/linux_server/0330nfs_2.php">鸟哥的 linux 私房菜 NFS 章节</a></p>

<h2 id="经验总结">经验总结</h2>

<ol>
<li>上报问题确实应该简洁，但需要包括最基本的问题重现的命令或操作</li>
<li>明面上看到的报错信息，可能和最终产生错误原因相距甚远，了解去何处查找相关日志非常重要。</li>
<li>虚拟机系统需要对各个用到的部件都有所了解才能定位问题，不然盲人摸象。比如 NFS， libvirt，virsh，tftp，nfs，甚至 selinux 需要好好了解学习一下。</li>
</ol>

<p>参考文档</p>

<blockquote>
<ul>
<li>Superuser <a href="https://superuser.com/questions/97844/how-can-i-determine-what-process-has-a-file-open-in-linux">How can I determine what process has a file open in Linux?</a></li>
<li>LAKSHMANAN G. (2012-08-29)  <a href="http://www.thegeekstuff.com/2012/08/lsof-command-examples/">Linux lsof Command Examples (Identify Open Files)</a></li>
<li><a href="https://www.cyberciti.biz/faq/howto-linux-get-list-of-open-files/">https://www.cyberciti.biz/faq/howto-linux-get-list-of-open-files/</a></li>
<li>nixCraft (2008-03-05) <a href="https://www.cyberciti.biz/faq/how-to-linux-re-apply-or-restore-selinux-security-labels-context/">List Open Files for Process</a></li>
<li><a href="http://cn.linux.vbird.org/linux_server/0210network-secure_4.php">鸟哥的 linux 私房菜 SELinux 管理原则</a></li>
</ul>
</blockquote>

<p>封面图片来自 <a href="https://dribbble.com/shots/1606433-I-m-a-computa">I&rsquo;m a computa</a> <a href="https://dribbble.com/Tymn"><i class="fa fa-dribbble" aria-hidden="true"></i> Tymn Armstrong</a></p>

<p>其他图片来源网络</p>
         <div id="disqus_thread">
  <a href="#" onclick="disqus();return false;"> 点击启用 Disqus 评论文章 <i class="fa fa-comments" aria-hidden="true"></i></a>
</div>

<script type="text/javascript">
var disqus_loaded = false;
function disqus() {
  if (!disqus_loaded) {
    
    
    
    

    disqus_loaded = true;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'wushuzh';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
};
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</div>
<noscript>
  <style>.jsonly { display: none }</style>
</noscript>

          </div>
      </div>
  </div>
  <script src="https://wushuzh.github.io/js/jquery.min.js"></script>
<script src="https://wushuzh.github.io/js/bootstrap.min.js"></script>
<script src="https://wushuzh.github.io/js/jquery.cookie.js"> </script>
<script src="https://wushuzh.github.io/js/ekko-lightbox.js"></script>
<script src="https://wushuzh.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://wushuzh.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/owl.carousel.min.js"></script>
<script src="https://wushuzh.github.io/js/front.js"></script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
