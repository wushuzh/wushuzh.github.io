<!DOCTYPE html>
<html lang="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>磁盘错误，咋整？</title>
<meta name="description" content="个人技术站点">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://wushuzh.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://wushuzh.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.theme.css">


  <link href="https://wushuzh.github.io/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://wushuzh.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://wushuzh.github.io/img/favicon.png">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-102509506-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="/">小强会武术</a></h1>
    
      <p class="sidebar-p">工程师</p>
    
      <p class="sidebar-p">认真记录每一个自己填平的坑</p>
    
    <ul class="sidebar-menu">
      
      
        <li><a href="https://wushuzh.github.io/">Home</a></li>
      
    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/Xiao_Qiang" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  <a href="mailto:wushuzh@outlook.com" data-animate-hover="pulse" class="email">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  
  

  
  <a href="https://wushuzh.github.io/index.xml" data-animate-hover="pulse">
    <i class='fa fa-rss'></i>
  </a>
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2017 wushuzh
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="/">小强会武术</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">

      <div class="row">
        <div class="col-sm-6">
          
            <div class="image">
              <img src="https://wushuzh.github.io//img/blog/deal-with-disk-error/hw-repair.png" class="img-responsive" alt="">
            </div>
          
        </div>
        <div class="col-md-6">
            <h2>磁盘错误，咋整？</h2>
                <p>
                  小强会武术
                </p>

                <time datetime="2017-07-22 20:14:43 &#43;0800 CST">
                <i class="fa fa-calendar-o fa-fw"></i> 2017-07-22
                </time>
                &middot;
                2073 字
                &middot;
                5 分钟

        </div>
      </div>
      <br />

         <p>磁盘错误导致进入紧急模式，该如何恢复？
</p>

<p>当前大数据应用的存储架构很少再采用 <a href="https://en.wikipedia.org/wiki/RAID">RAID</a> ——此领域最常听到的是 JBOD ，隶属于<a href="https://en.wikipedia.org/wiki/Non-RAID_drive_architectures">Non-RAID drive architectures</a></p>

<p>但本文涉及的老系统不但使用了 <a href="https://zh.wikipedia.org/wiki/RAID">磁盘冗余阵列</a>，而且不是在硬件层面(智能存储阵列控制器)上直接做 RAID，而使用的是 SW-RAID，并且不是普通 RAID，而是<a href="https://en.wikipedia.org/wiki/Nested_RAID_levels">嵌套 RAID</a> …… 怎么看都挺复杂的。</p>

<h3 id="案例-3-磁盘受损">案例 3 磁盘受损</h3>

<p>(案例 1， 2 见 <a href="/blog/2017/07/19/deal-with-boot-failure/">启动错误，咋整？</a> )</p>

<p>问题描述：这是一台用于模拟客户生产环境的服务器，一年多没重装，仅通过常规产品升级维护着。上电后，据说遇到了磁盘错误，被强制进入维护模式，之后管理员将问题分区从 fstab 中注释掉，系统可以正常启动，但在修复磁盘和恢复软 RAID 遇到了麻烦。</p>

<hr />

<ul>
<li>首先 /proc/mdstat 查看出问题的冗余阵列分区，处于 inactive 状态，由四个分区组成。<br /></li>
</ul>

<blockquote>
<p>另有配置文件 /etc/mdadm.conf</p>
</blockquote>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# cat /proc/mdstat <span style="color: #f8f8f2">|</span>grep -A <span style="color: #ae81ff">3</span> md5
md5 : inactive sds1[0](S) sdo1[1](S) sdk1[2](S) sdg1[3](S)
      1464306688 blocks super 1.1

[root@hostC ~]#
</pre></div>


<hr />

<ul>
<li>mdadm 命令查看此冗余阵列的磁盘分区详情，RAID Level 为 raid0，查看产品设计文档，此处应该为 raid10 ，即需要重新将下属 4 个分区做 RAID 组装。</li>
</ul>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# mdadm --detail /dev/md5
/dev/md5:
        Version : 1.1
     Raid Level : raid0
  Total Devices : 4
    Persistence : Superblock is persistent

          State : inactive

           Name : hostC:5  (local to host hostC)
           UUID : cb622579:188d8cef:0c91003b:04e85a9e
         Events : 24562603

    Number   Major   Minor   RaidDevice

       -       8       97        -        /dev/sdg1
       -       8      161        -        /dev/sdk1
       -       8      225        -        /dev/sdo1
       -      65       33        -        /dev/sds1
</pre></div>


<hr />

<ul>
<li>检查( -E &ndash;examine )下属各个磁盘的状态，几个下属块设备也都印证了他们应为 raid10 ，但各个盘的 event 标号都不一致，更新时间有的追溯到很早，另外各个磁盘的状态也都不是 AAAA，猜测这块磁盘已经带病工作很久了，这次搬家，运输过程中一颠一震，再也坚持不下去，撂挑子休息了……</li>
</ul>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# mdadm -E /dev/sd<span style="color: #f92672">[</span>gkos<span style="color: #f92672">]</span><span style="color: #ae81ff">1</span>
/dev/sdg1:
          Magic : a92b4efc
        Version : 1.1
    Feature Map : 0x1
     Array UUID : cb622579:188d8cef:0c91003b:04e85a9e
           Name : hostC:5  (local to host hostC)
  Creation Time : Tue Feb  2 10:28:01 2016
     Raid Level : raid10
   Raid Devices : 4

 Avail Dev Size : 585607168 (279.24 GiB 299.83 GB)
     Array Size : 585606144 (558.48 GiB 599.66 GB)
  Used Dev Size : 585606144 (279.24 GiB 299.83 GB)
    Data Offset : 262144 sectors
   Super Offset : 0 sectors
   Unused Space : before=262072 sectors, after=1024 sectors
          State : clean
    Device UUID : 9941486b:d67ae4a0:f36d875e:eea1faf9

Internal Bitmap : 8 sectors from superblock
    Update Time : Sat Jul 15 15:10:19 2017
       Checksum : adb90efa - correct
         Events : 24562603

         Layout : near=2
     Chunk Size : 512K

 Device Role : Active device 3
 Array State : A..A (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
</pre></div>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span> /dev/sdk1:

             ... : ...
           State : clean
     Device UUID : a55812c0:c4beff84:d6236c75:8a1b6d64

 Internal Bitmap : 8 sectors from superblock
     Update Time : Wed Jul 27 18:07:15 2016
        Checksum : 64aca313 - correct
          Events : 3408

          Layout : near=2
      Chunk Size : 512K

  Device Role : Active device 2
  Array State : A.AA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
</pre></div>
</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span> /dev/sdo1:

             ... : ...
           State : clean
     Device UUID : 1c0e9a86:eddcc56f:b243204d:82a91aea

 Internal Bitmap : 8 sectors from superblock
     Update Time : Wed Jul 27 18:07:10 2016
        Checksum : 735f2476 - correct
          Events : 3398

          Layout : near=2
      Chunk Size : 512K

  Device Role : Active device 1
  Array State : AAAA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
</pre></div>


<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span> /dev/sds1:

             ... : ...
           State : clean
     Device UUID : cc52449a:dbbc9518:ae736e28:c5424d37

 Internal Bitmap : 8 sectors from superblock
     Update Time : Sat Jul 15 15:10:05 2017
        Checksum : 7e908098 - correct
          Events : 24562577

          Layout : near=2
      Chunk Size : 512K

  Device Role : Active device 0
  Array State : A..A (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
</pre></div>


<hr />

<ul>
<li>先将相应冗余阵列停掉，再重新组装。</li>
</ul>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# mdadm --stop /dev/md5
mdadm: stopped /dev/md5

[root@hostC ~]# mdadm --assemble --scan
mdadm: /dev/md/5 assembled from 1 drive - not enough to start the array.
</pre></div>


<p>这里的报错应该是因为 mdadm 还不够智能(或者不想担责任)，需要我们将其下属磁盘都显示指定，才能继续组装。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# mdadm --assemble /dev/md5 /dev/sd<span style="color: #f92672">[</span>gkos<span style="color: #f92672">]</span><span style="color: #ae81ff">1</span>
mdadm: /dev/sdg1 is busy - skipping
mdadm: /dev/sdk1 is busy - skipping
mdadm: /dev/sdo1 is busy - skipping
mdadm: /dev/sds1 is busy - skipping
</pre></div>


<p>手动显式指定了，但又遇到设备正忙的错误。之后我又执行了一次 mdadm 停止命令，之后立即执行组装命令，成功了。但仍然显示仅仅组装上了总共 4 块磁盘中的 3 块。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# mdadm --manage /dev/md5 --stop
mdadm: stopped /dev/md5

[root@hostC ~]# mdadm --assemble --force /dev/md5 /dev/sd<span style="color: #f92672">[</span>gkos<span style="color: #f92672">]</span><span style="color: #ae81ff">1</span>
mdadm: forcing event count in /dev/sds1(0) from 24562577 upto 24562603
mdadm: forcing event count in /dev/sdk1(2) from 3408 upto 24562603
mdadm: clearing FAULTY flag for device 1 in /dev/md5 for /dev/sdk1
mdadm: Marking array /dev/md5 as &#39;clean&#39;
mdadm: /dev/md5 has been started with 3 drives (out of 4).
</pre></div>


<hr />

<p>此时再查看冗余磁盘阵列的状态，已变为 clean degraded 的状态。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# mdadm --detail /dev/md5
/dev/md5:
            ... : ...
     Raid Level : raid10
     Array Size : 585606144 (558.48 GiB 599.66 GB)
  Used Dev Size : 292803072 (279.24 GiB 299.83 GB)
   Raid Devices : 4
  Total Devices : 3
    Persistence : Superblock is persistent
            ... : ...
    Update Time : Wed Jul 19 16:45:09 2017
          State : clean, degraded
 Active Devices : 3
Working Devices : 3
 Failed Devices : 0
  Spare Devices : 0
            ... : ...
           UUID : cb622579:188d8cef:0c91003b:04e85a9e
         Events : 24562649

    Number   Major   Minor   RaidDevice State
       0      65       33        0      active sync set-A   /dev/sds1
       -       0        0        1      removed
       2       8      161        2      active sync set-A   /dev/sdk1
       3       8       97        3      active sync set-B   /dev/sdg1

[root@hostC ~]# cat /proc/mdstat <span style="color: #f8f8f2">|</span>grep -A <span style="color: #ae81ff">3</span> md5
md5 : active raid10 sds1[0] sdk1[2] sdg1[3]
      585606144 blocks super 1.1 512K chunks 2 near-copies [4/3] [U_UU]
      bitmap: 5/5 pages [20KB], 65536KB chunk
</pre></div>


<hr />

<p>而下属的各个磁盘，除 /dev/sdo1 以外，Event # 都已同步。</p>

<h2 id="hahahugoshortcode-12hbhb"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC temp]# mdadm -E /dev/sd<span style="color: #f92672">[</span>gkos<span style="color: #f92672">]</span><span style="color: #ae81ff">1</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f8f8f2">|</span> grep <span style="color: #f92672">[</span>Events<span style="color: #f8f8f2">|</span>Update<span style="color: #f8f8f2">|</span>Array State<span style="color: #f8f8f2">|</span><span style="color: #f92672">]</span>

/dev/sdg1:
    Update Time : Wed Jul 19 16:49:45 2017
         Events : 24562841
   Array State : A.AA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
/dev/sdk1:
    Update Time : Wed Jul 19 16:49:45 2017
         Events : 24562841
   Array State : A.AA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
/dev/sdo1:
    Update Time : Wed Jul 27 18:07:10 2016
         Events : 3398
   Array State : AAAA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
/dev/sds1:
    Update Time : Wed Jul 19 16:49:45 2017
         Events : 24562841
   Array State : A.AA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
</pre></div>
</h2>

<p>之后将 fstab 中拿掉的行重新拿回，重启服务器，但又一次被强制进入维护模式</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>Welcome to emergency mode! After logging in, type &quot;journalctl -xb&quot; to view
system logs, &quot;systemctl reboot&quot; to reboot, &quot;systemctl default&quot; or ^D to
try again to boot into default mode.
Give root password for maintenance
(or type Crontrol-D to continue):
</pre></div>


<hr />

<p>按提示进入执行 journalctl 查看日志，发现磁盘需要修复，大概和之前没有装载上的磁盘有点关系？</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>some-timestamp hostC systemd-fsck[1631]:
  /dev/md5: Inode xxx has a bad extended attribute block yyy.
some-timestamp hostC systemd-fsck[1631]:
  /dev/md5: UNEXPECTED INCONSISTENCY: RUN fsck MANUALLY.
some-timestamp hostC systemd-fsck[1631]:
  (i.e., without -a or -p options)
some-timestamp hostC systemd-fsck[1631]:
  fsck failed with error code 4.
some-timestamp hostC systemd-fsck[1631]:
  Running request emergency.target/start/replace
some-timestamp hostC systemd[1]:
  Started File System Check on /dev/disk/by-uuid/aaa-bbb-ccc-ddd-......
</pre></div>


<p>因为系统已经处于维护模式，之后的修复相对简单。可以参考 Antoine (2014-03-14) <a href="http://bitsofmymind.com/2014/03/14/how-to-fix-fsck-your-root-file-system-that-you-have-to-boot-into-on-linux/">how-to-fix-fsck-your-root-file-system-that-you-have-to-boot-into-on-linux</a></p>

<p>其中一个可能遇到的问题是 fsck 命令相应设备已经挂载，无法继续执行的错误，可以将相应报错的设备或挂机点重挂载为只读，然后再执行磁盘检测。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# df -h <span style="color: #f8f8f2">|</span>grep md5
/dev/md5    550G    56G    467G    11%    /somefolder
[root@hostC ~]# fsck /dev/md5
e2fsck 1.42.9 (28-Dec-2013)
/dev/md5 is mounted.
e2fsck: Cannot continue, aborting.

[root@hostC ~]# cat /proc/mounts <span style="color: #f8f8f2">|</span>grep md5
/dev/md5 /somefolder ext4 rw,nodev,relatime,stripe=256,data=ordered 0 0
[root@hostC ~]# mount -o remount,ro /somefolder
[root@hostC ~]# cat /proc/mounts <span style="color: #f8f8f2">|</span>grep md5
/dev/md5 /somefolder ext4 ro  ,nodev,relatime,stripe=256,data=ordered 0 0
[root@hostC ~]# fsck -y /dev/md5
...
</pre></div>


<p>修复完毕后，将冗余阵列组装为 4 块设备，重启服务器，顺利进入系统。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# mdadm --manage /dev/md5 -a /dev/sdo1
mdadm: added /dev/sdo1
</pre></div>


<p>可以执行命令 <code>watch -n .5 cat /proc/mdstat</code> 每隔 0.5 秒监控一下冗余阵列的同步状态。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>[root@hostC ~]# mdadm --detail /dev/md5
/dev/md5:
   Raid Devices : 4
  Total Devices : 3
    Update Time : Fri Jul 21 10:49:52 2017
            ... : ...
          State : active, degraded, recovering
 Active Devices : 3
Working Devices : 4
 Failed Devices : 0
  Spare Devices : 1

Rebuild Status : 59% complete

    Number   Major   Minor   RaidDevice State
       0      65       33        0      active sync set-A   /dev/sds1
       4       8      225        1      spare rebuilding   /dev/sdo1
       2       8      161        2      active sync set-A   /dev/sdk1
       3       8       97        3      active sync set-B   /dev/sdg1

[root@hostC ~]# mdadm -E /dev/sd<span style="color: #f92672">[</span>sokg<span style="color: #f92672">]</span><span style="color: #ae81ff">1</span> <span style="color: #ae81ff">\</span>
    <span style="color: #f8f8f2">|</span> grep <span style="color: #f92672">[</span>dev<span style="color: #f8f8f2">|</span>Array State<span style="color: #f92672">]</span>
/dev/sdg1:
   Array State : AAAA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
/dev/sdk1:
   Array State : AAAA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
/dev/sdo1:
   Array State : AAAA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
/dev/sds1:
   Array State : AAAA (&#39;A&#39; == active, &#39;.&#39; == missing, &#39;R&#39; == replacing)
</pre></div>


<p>缩略语解释</p>

<p>另外，TECMINT 上有一篇<a href="https://www.tecmint.com/create-raid-10-in-linux/">创建 RAID10 的方法</a>，有助于理解。</p>

<p>封面图片来自 <a href="https://dribbble.com/shots/2287977-Computer-repair">Computer repair</a> <a href="https://dribbble.com/Frizler"><i class="fa fa-dribbble" aria-hidden="true"></i> Anton Fritsler</a></p>
         <div id="disqus_thread">
  <a href="#" onclick="disqus();return false;">enable VPN and click here to <i class="fa fa-comments" aria-hidden="true"></i></a>
</div>

<script type="text/javascript">
var disqus_loaded = false;
function disqus() {
  if (!disqus_loaded) {
    
    
    
    

    disqus_loaded = true;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'wushuzh';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
};
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</div>
<noscript>
  <style>.jsonly { display: none }</style>
</noscript>

          </div>
      </div>
  </div>
  <script src="https://wushuzh.github.io/js/jquery.min.js"></script>
<script src="https://wushuzh.github.io/js/bootstrap.min.js"></script>
<script src="https://wushuzh.github.io/js/jquery.cookie.js"> </script>
<script src="https://wushuzh.github.io/js/ekko-lightbox.js"></script>
<script src="https://wushuzh.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://wushuzh.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/owl.carousel.min.js"></script>
<script src="https://wushuzh.github.io/js/front.js"></script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
