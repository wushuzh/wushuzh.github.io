<!DOCTYPE html>
<html lang="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>双系统 2: Linux</title>
<meta name="description" content="个人技术站点">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://wushuzh.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://wushuzh.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.theme.css">


  <link href="https://wushuzh.github.io/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://wushuzh.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://wushuzh.github.io/img/favicon.png">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-102509506-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="/">小强会武术</a></h1>
    
      <p class="sidebar-p">工程师</p>
    
      <p class="sidebar-p">记录每一个自己填平的坑</p>
    
    <ul class="sidebar-menu">
      
      
        <li><a href="https://wushuzh.github.io/">Home</a></li>
      
    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/Xiao_Qiang" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  <a href="mailto:wushuzh@outlook.com" data-animate-hover="pulse" class="email">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  
  

  
  <a href="https://wushuzh.github.io/index.xml" data-animate-hover="pulse">
    <i class='fa fa-rss'></i>
  </a>
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2017 wushuzh
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="/">小强会武术</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">

      <div class="row">
        <div class="col-sm-6">
          
            <div class="image">
              <img src="https://wushuzh.github.io//img/blog/dual-os-2-install-arch/linux-m.png" class="img-responsive" alt="">
            </div>
          
        </div>
        <div class="col-md-6">
            <h2>双系统 2: Linux</h2>
                <p>
                  小强会武术
                </p>

                <time datetime="2017-08-10 18:48:26 &#43;0800 CST">
                <i class="fa fa-calendar-o fa-fw"></i> 2017-08-10
                </time>
                &middot;
                1660 字
                &middot;
                4 分钟

        </div>
      </div>
      <br />

         <p>选择哪个 Linux 版本？是个问题
</p>

<h2 id="linux-版本">Linux 版本</h2>


<figure >
    
        <img src="/img/blog/dual-os-2-install-arch/linux-flavour.jpg" />
    
    
    <figcaption>
        <h4>Decision Tree</h4>
        
    </figcaption>
    
</figure>


<p>上面的决策树送给犹豫不决的你。为了促使自己不断地折腾，同时显得比较硬核，我依然选择 Arch Linux。</p>

<h2 id="制作-u-盘">制作 U 盘</h2>

<p><a href="https://www.archlinux.org/download/">官网</a>下载安装介质 ：我下载的是 2017.08.01 的版本，内核 4.12.3，ISO 大小 516 MB。
等待下载的同时，开个浏览器阅读 <a href="https://wiki.archlinux.org/index.php/USB_flash_installation_media#In_Windows">USB flash installation media</a>, 然后从中挑一种顺眼的方法——我选 dd for Windows——将安装介质写入 U 盘。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>choco install dd -y

wmic diskdrive list brief
  Caption           DeviceID            Model  Partitions  Size
  Hitachi HDS72xxx  \\.\PHYSICALDRIVE0  ...    3           nnnnn
  Kingston Datayyy  \\.\PHYSICALDRIVE1  ...    1           mmmmm

dd if=archlinux-2017.08.01-x86_64.iso of=\\.\PHYSICALDRIVE1 bs=4M
  rawwrite dd for windows version 0.5
  ......
  129+0 records in
  129+0 records out
</pre></div>


<p><br /></p>

<h2 id="引导模式">引导模式</h2>

<p>先上个双保险——就算 Linux 安装失败——仍能回到 Windows ，再次确认计算机的引导模式。</p>

<ul>
<li>使用<code>diskpart</code>，详见<a href="/blog/2017/08/03/dual-os-1-install-win/">&ldquo;双系统 1: 微软视窗&rdquo;</a> ；</li>
<li>使用<code>msinfo32</code>，选择根节点“系统摘要”，查看右侧面板中的 BIOS 模式的值，如果为&rdquo;传统&rdquo;或&rdquo;Legacy&rdquo;，就是 BIOS-MBR 模式，若为 UEFI，就是 UEFI-GPT 模式。</li>
</ul>

<p>然后根据这个信息和当前 Windows 版本反复阅读 <a href="https://wiki.archlinux.org/index.php/Dual_boot_with_Windows">ArchLinux 双启动 wiki</a> 相关章节——同学们，这里面全是知识点啊: chainload、bootloader、GRUB、GRUB Legacy、Syslinux、UEFI、BIOS、GPT、MBR——反正务必做到谋定而后动。</p>

<p>我的机器非常老了，只能采用 BIOS-MBR 模式。关于分区，<a href="https://wiki.archlinux.org/index.php/Talk:Dual_boot_with_Windows#MBR-BIOS">Talk:Dual_boot_with_Windows#MBR-BIOS</a> 还提到了另一种实现双启动的办法：即先分区，然后安装 Windows ，之后装 Linux ，并在最后用 grub-install 等工具覆盖 Windows 引导区。这应该也可行——甚至更好——但这需要重新安装 Windows 我这回并没有采用。</p>

<h2 id="关于时钟">关于时钟</h2>

<p>之前已经为 Windows 设置了 ntp 同步，为了之后双系统的时间互不干扰，应该统一将硬件系统时间(BIOS 中)和 Windows 系统时间(要通过修改注册表实现)都设定为 UTC 配合。详见 <a href="https://wiki.archlinux.org/index.php/Dual_boot_with_Windows#Time_standard">Time std wiki</a></p>

<h2 id="动手安装">动手安装</h2>

<p>BIOS 设好 U 盘启动，进入系统(命令行终端)开始做安装前配置。值得一提的是系统提供多个虚拟终端间供你自由切换，按下 <code>Alt + 方向键</code> ，设好代理，启动一个文本型的 Web 浏览器查看安装在线文档。最好只看英文，图片当然也看不了。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">export</span> <span style="color: #f8f8f2">http_proxy</span><span style="color: #f92672">=</span>YOUR_PROXY
elinks wiki.archlinux.org/index.php/Installation_guide
</pre></div>


<p><br /></p>

<h3 id="磁盘分区-格式化和挂载">磁盘分区、格式化和挂载</h3>

<h4 id="磁盘分区">磁盘分区</h4>

<p>之前已经预留了 100+ GB 的未分区空间用于 Linux 安装。<code>fdisk -l</code>查看确认。已安装的 Windows 8 占用了</p>

<ul>
<li>/dev/sda1 350M (Type: HPFS/NTFS/exFAT id: 7)</li>
<li>/dev/sda2 150G 对应 C 盘 (同上)</li>
<li>/dev/sda3 38G 对应 D 盘 (同上)</li>
</ul>

<p>MBR 上的 3 个主分区都已被占用，Linux 必须通过扩展分区实现，通过<code>fdisk /dev/sda</code> 或 parted 工具尝试完成如下分区:</p>

<ol>
<li>新建扩展分区 /dev/sda4 含所有未分配空间 (Type: Extended id: 5)</li>
<li>新建逻辑分区 /dev/sda5 200 MB (Type: Linux 0x83)</li>
<li>新建逻辑分区 /dev/sda6 80 GB (Type: Linux  0x83)</li>
<li>新建交换分区 /dev/sda7 4 GB (Type: Linux swap / Solaris 0x82)</li>
<li>新建双系统共享区 /dev/sda8 20 GB (Type: W95 FAT32 (LBA) 0x0c)</li>
</ol>

<p><br /></p>

<h4 id="文件系统格式化和挂载">文件系统格式化和挂载</h4>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e"># 文件系统格式化</span>
mkfs.ext3 /dev/sda5
mkfs.ext4 /dev/sda6
mkswap /dev/sda7
mkfs.vfat /dev/sda8

<span style="color: #75715e"># 挂载</span>
mount /dev/sda6 /mnt
mkdir /mnt/boot
mount /dev/sda5 /mnt/boot
swapon /dev/sda7
mkdir /mnt/greenzone
mount -t vfat /dev/sda8 /mnt/greenzone
</pre></div>


<blockquote>
<p>后面专门再写一篇如何通过 LVM 进行分区。</p>
</blockquote>

<h3 id="系统安装和配置">系统安装和配置</h3>

<p>Archlinux 追新：安装的软件都从网上下载最新版：这里修改其镜像文件<code>/etc/pacman.d/mirrorlist</code>，将自己所在国家的地址移到最上边就可以了。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e"># 安装核心软件</span>
pacstrap /mnt base

<span style="color: #75715e"># 生成文件系统挂载表</span>
genfstab -U /mnt &gt;&gt; /mnt/etc/fstab

<span style="color: #75715e"># 切换到新安装到硬盘的文件系统上</span>
arch-chroot /mnt

<span style="color: #75715e"># 配置时间</span>
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
hwclock --systohc

<span style="color: #75715e"># 配置本地化字符</span>
vi /etc/locale.gen
locale-gen

<span style="color: #75715e"># 配置主机名</span>
/etc/hostname
/etc/hosts  

<span style="color: #75715e"># 配置 root 密码</span>
passwd
</pre></div>


<h3 id="引导区设定">引导区设定</h3>

<p>这部分是双系统最核心的部分——Linux 和 Windows 的双启动能否成功在此一举。首先，继续上面的 root shell 会话，安装 grub 程序，将启动程序和配置都安装在 /boot (sda5) 上。然后将其关键文件(core.img)设定为不可更改，重新生成 grub.cfg 中相关磁盘的 uuid。将用 /boot 分区的前 512 个字节，输出到共享分区备用。</p>

<blockquote>
<p>尚不知道是否每次更新 Linux 内核时都需要做这一系列的操作</p>
</blockquote>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>pacman -S grub

grub-install --target<span style="color: #f92672">=</span>i386-pc <span style="color: #ae81ff">\</span>
    --grub-setup<span style="color: #f92672">=</span>/bin/true --recheck --debug /dev/sda5
chattr +i /boot/grub/i386-pc/core.img
pacman -S linux
grub-mkconfig -o /boot/grub/grub.cfg

dd <span style="color: #66d9ef">if</span><span style="color: #f92672">=</span>/dev/sda5 <span style="color: #f8f8f2">of</span><span style="color: #f92672">=</span>/greenzone/linux.bin <span style="color: #f8f8f2">bs</span><span style="color: #f92672">=</span><span style="color: #ae81ff">512</span> <span style="color: #f8f8f2">count</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span>
</pre></div>


<p>重启回到 Windows 8，打开一个带有管理员权限的命令行，拷贝刚才准备的引导区文件 linux.bin，在使用 Windows 的 bootLoader 更新配置，为其追加一个 Linux 启动项。将其和 GRUB 的 bootloader 级联，达到启动 Linux 的目的。重启，测试 Windows 和 Linux 的引导。</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">REM copy the file linux.bin from F: to C:</span>
bcdedit /create /d <span style="color: #e6db74">&quot;Linux&quot;</span> /application BOOTSECTOR

bcdedit /set {ID} device partition=c:
bcdedit /set {ID}  path \linux.bin
bcdedit /displayorder {ID} /addlast
bcdedit /timeout 30
</pre></div>


<p><br /></p>

<h3 id="参考文档">参考文档</h3>

<blockquote>
<ul>
<li>Archlinux wiki <a href="https://wiki.archlinux.org/index.php/Installation_guide">Installation guide</a></li>
<li>Archlinux wiki <a href="https://wiki.archlinux.org/index.php/Dual_boot_with_Windows#Using_Windows_boot_loader">Dual boot with Windows # Using Windows boot loader</a></li>
<li>Archlinux wiki <a href="https://wiki.archlinux.org/index.php/GRUB/Tips_and_tricks#Install_to_partition_or_partitionless_disk">GRUB/Tips and tricks # Install to partition disk</a></li>
<li>iceflatline 2009-09-16 <a href="https://www.iceflatline.com/2009/09/how-to-dual-boot-windows-7-and-linux-using-bcdedit/">How to Dual Boot Windows 7 and Linux using BCDEdit</a></li>
<li>Ashwin Kailas (2016-11-16) <a href="https://medium.com/@ashwinkailas/arch-linux-lvm-dual-boot-with-windows-tutorial-e327ea8f3140">Arch Linux (LVM) dual-boot with Windows tutorial</a> 文中涉及更先进的 EFI 引导模式，但可参考 LVM 的划分方式</li>
</ul>
</blockquote>

<p>封面图片来自 <a href="https://dribbble.com/shots/1862256-Introduction-to-Linux">Introduction to Linux</a> <a href="https://dribbble.com/kabojanowska"><i class="fa fa-dribbble" aria-hidden="true"></i> Kasia</a></p>
         <div id="disqus_thread">
  <a href="#" onclick="disqus();return false;">enable VPN and click here to <i class="fa fa-comments" aria-hidden="true"></i></a>
</div>

<script type="text/javascript">
var disqus_loaded = false;
function disqus() {
  if (!disqus_loaded) {
    
    
    
    

    disqus_loaded = true;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'wushuzh';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
};
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</div>
<noscript>
  <style>.jsonly { display: none }</style>
</noscript>

          </div>
      </div>
  </div>
  <script src="https://wushuzh.github.io/js/jquery.min.js"></script>
<script src="https://wushuzh.github.io/js/bootstrap.min.js"></script>
<script src="https://wushuzh.github.io/js/jquery.cookie.js"> </script>
<script src="https://wushuzh.github.io/js/ekko-lightbox.js"></script>
<script src="https://wushuzh.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://wushuzh.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/owl.carousel.min.js"></script>
<script src="https://wushuzh.github.io/js/front.js"></script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
