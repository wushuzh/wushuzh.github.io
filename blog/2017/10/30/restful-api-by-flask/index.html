<!DOCTYPE html>
<html lang="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>RestFul API</title>
<meta name="description" content="个人技术站点">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://wushuzh.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://wushuzh.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.theme.css">


  <link href="https://wushuzh.github.io/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://wushuzh.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://wushuzh.github.io/img/favicon.png">


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-102509506-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="/">小强会武术</a></h1>
    
      <p class="sidebar-p">工程师</p>
    
      <p class="sidebar-p">记录每一个自己填平的坑</p>
    
    <ul class="sidebar-menu">
      
      
        <li><a href="https://wushuzh.github.io/">Home</a></li>
      
    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/Xiao_Qiang" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  <a href="mailto:wushuzh@outlook.com" data-animate-hover="pulse" class="email">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  
  

  
  <a href="https://wushuzh.github.io/index.xml" data-animate-hover="pulse">
    <i class='fa fa-rss'></i>
  </a>
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2017 wushuzh
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="/">小强会武术</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">

      <div class="row">
        <div class="col-sm-6">
          
            <div class="image">
              <img src="https://wushuzh.github.io//img/blog/restful-api-by-flask/rest.gif" class="img-responsive" alt="">
            </div>
          
        </div>
        <div class="col-md-6">
            <h2>RestFul API</h2>
                <p>
                  小强会武术
                </p>

                <time datetime="2017-10-30 11:24:09 &#43;0800 CST">
                <i class="fa fa-calendar-o fa-fw"></i> 2017-10-30
                </time>
                &middot;
                973 字
                &middot;
                2 分钟

        </div>
      </div>
      <br />

         <p>当下还在流行使用的远程通信方式
</p>

<p>本文是对 Bruno Krebs (2017-09-28) <a href="https://auth0.com/blog/developing-restful-apis-with-python-and-flask/">Developing RESTful APIs with Python and Flask</a> 的实践版。其基本步骤是</p>

<ul>
<li>搭建环境和基础代码</li>
<li>定义 RESTful API</li>
<li>和 python 类映射</li>
<li>容器化</li>
</ul>

<h3 id="准备环境">准备环境</h3>

<p>步骤如下:</p>

<ul>
<li>用 pipenv 创建一个 py3 含 flask 的虚拟环境</li>
<li>cashman 模块化: init 和 最简 index.py</li>
<li>创建启动脚本 bootstrap.sh 用于启动上述应用</li>
<li>创建 git 仓库提交初始版本</li>
</ul>

<h3 id="原型实验">原型实验</h3>

<p>目标是管理收支，首先是处理收入的两个 API 。不同的仅是动词: GET 和 POST，路经一样: 都是 incomes</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ export no_proxy=localhost
$ curl http://localhost:5000/incomes
[
  {
    &#34;amount&#34;: 5000, 
    &#34;description&#34;: &#34;salary&#34;
  }
]
$ curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;{
&gt;    &#34;description&#34;: &#34;lottery&#34;,
&gt;    &#34;amount&#34;: 1000.0
&gt; }&#39; http://localhost:5000/incomes

$ curl http://localhost:5000/incomes
[
  {
    &#34;amount&#34;: 5000, 
    &#34;description&#34;: &#34;salary&#34;
  }, 
  {
    &#34;amount&#34;: 1000.0, 
    &#34;description&#34;: &#34;lottery&#34;
  }
]</code></pre></div>

<h3 id="序列和对象的转换">序列和对象的转换</h3>

<p>步骤如下:</p>

<ul>
<li>cashman 模块下创建子模块 model</li>
<li>安装 marshmallow</li>
<li>创建基类 Transaction 及 TransactionSchema 后者用于 python 和 json 的相互转化</li>
<li>创建子类 Income 和 Expense 和它们的 Schema 类，并装饰为在反序列化时实例化为 python 对象</li>
<li>在 index 中整合上述对象，分别添加 incomes 和 expenses 的 GET 和 POST 处理</li>
</ul>

<p>尤其是子类中使用了 python 的内置函数 super，详见</p>

<ul>
<li><a href="https://docs.python.org/3.6/library/functions.html#super">py3 stddoc super</a></li>
<li>Raymond Hettinger (2011-05-26) <a href="https://rhettinger.wordpress.com/2011/05/26/super-considered-super/">Python’s super() considered super!</a></li>
<li>Stackoverflow 上 Aaron Hall 的回答 <a href="https://stackoverflow.com/a/27134600/4393386">Understanding Python super() with init methods</a> <a href="https://stackoverflow.com/a/33469090/4393386">What does &lsquo;super&rsquo; do in Python?</a></li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ ./bootstrap.sh &amp;
$  * Serving Flask app &#34;cashman.index&#34;
 * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)

$ curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;{
    &#34;amount&#34;: 300.0,
    &#34;description&#34;: &#34;loan payment&#34;
}&#39; http://localhost:5000/incomes
127.0.0.1 - - [31/Oct/2017 11:40:22] &#34;POST /incomes HTTP/1.1&#34; 204 -
$ curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;{
    &#34;amount&#34;: 20,
    &#34;description&#34;: &#34;lottery ticket&#34;
}&#39; http://localhost:5000/expenses
127.0.0.1 - - [31/Oct/2017 11:40:34] &#34;POST /expenses HTTP/1.1&#34; 204 -
$ curl http://localhost:5000/expenses
127.0.0.1 - - [31/Oct/2017 11:40:43] &#34;GET /expenses HTTP/1.1&#34; 200 -
[
  {
    &#34;amount&#34;: -50.0, 
    &#34;created_at&#34;: &#34;2017-10-31T11:40:13.333592&#34;, 
    &#34;description&#34;: &#34;pizza&#34;, 
    &#34;typ&#34;: &#34;TransactionType.EXPENSE&#34;
  }, 
  {
    &#34;amount&#34;: -100.0, 
    &#34;created_at&#34;: &#34;2017-10-31T11:40:13.333596&#34;, 
    &#34;description&#34;: &#34;Rock Concert&#34;, 
    &#34;typ&#34;: &#34;TransactionType.EXPENSE&#34;
  }, 
  {
    &#34;amount&#34;: -20.0, 
    &#34;created_at&#34;: &#34;2017-10-31T11:40:34.306376&#34;, 
    &#34;description&#34;: &#34;lottery ticket&#34;, 
    &#34;typ&#34;: &#34;TransactionType.EXPENSE&#34;
  }
]
$ curl http://localhost:5000/incomes
127.0.0.1 - - [31/Oct/2017 11:40:49] &#34;GET /incomes HTTP/1.1&#34; 200 -
[
  {
    &#34;amount&#34;: 5000.0, 
    &#34;created_at&#34;: &#34;2017-10-31T11:40:13.333573&#34;, 
    &#34;description&#34;: &#34;Salary&#34;, 
    &#34;typ&#34;: &#34;TransactionType.INCOME&#34;
  }, 
  {
    &#34;amount&#34;: 200.0, 
    &#34;created_at&#34;: &#34;2017-10-31T11:40:13.333588&#34;, 
    &#34;description&#34;: &#34;Dividends&#34;, 
    &#34;typ&#34;: &#34;TransactionType.INCOME&#34;
  }, 
  {
    &#34;amount&#34;: 300.0, 
    &#34;created_at&#34;: &#34;2017-10-31T11:40:22.923553&#34;, 
    &#34;description&#34;: &#34;loan payment&#34;, 
    &#34;typ&#34;: &#34;TransactionType.INCOME&#34;
  }
]</code></pre></div>

<h3 id="容器封装">容器封装</h3>

<p>这里使用是基于 <a href="https://en.wikipedia.org/wiki/Alpine_Linux">Alpine</a> 的镜像，特点是精简，大小仅 80M+，而一般的 python3 镜像则 680M+。并作了安全、网络等方面的增强。</p>

<blockquote>
<p>值得注意的是 Alpine 使用自己的包管理工具 apk，而其代理的设置根据这个 issus <a href="https://github.com/gliderlabs/docker-alpine/issues/171">#171 Running apk commands behind proxy fails</a> 要写作完整形式。</p>
</blockquote>

<p>和原文不同，我依然借助 docker-machine 做 image 的编译和运行，但遇到了报错。docker 的查错依然是通过 logs 命令查看日志，然后可以重启并改写 entrypoint 再进入交互模式。更多方法可以参考 Mark Betz (2016-03-24) <a href="https://medium.com/@betz.mark/ten-tips-for-debugging-docker-containers-cde4da841a1d">Ten tips for debugging Docker containers</a></p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ eval $(docker-machine env --no-proxy dev)
$ docker build -t cashman \
    --build-arg http_proxy=http://ip:port \
    --build-arg https_proxy=http://ip:port 
    .

$ docker run --name cashman \
     -d -p 5000:5000 \
     cashman
&lt;hashid&gt;

$ docker ps
$ docker ps -a
$ docker logs &lt;hashid&gt;
standard_init_linux.go:195: exec user process caused &#34;no such file or directory&#34;

$ docker run --name cashman -it --entrypoint /bin/sh cashman
/usr/src/app # ./bootstrap.sh &amp;
/usr/src/app # /bin/sh: ./bootstrap.sh: not found
/usr/src/app # ls -l /bin/bash
ls: /bin/bash: No such file or directory
/usr/src/app # ls -l /bin/sh
lrwxrwxrwx    1 root     root            12 Oct 25 22:05 /bin/sh -&gt; /bin/busybox

# modify bootstrap shebang to /bin/sh and rebuilt rerun and check
$ curl http://$(docker-machine ip dev):5000/incomes
[
  {
    &#34;amount&#34;: 5000.0, 
    &#34;created_at&#34;: &#34;2017-10-31T08:39:52.342714&#34;, 
    &#34;description&#34;: &#34;Salary&#34;, 
    &#34;typ&#34;: &#34;TransactionType.INCOME&#34;
  }, 
  {
    &#34;amount&#34;: 200.0, 
    &#34;created_at&#34;: &#34;2017-10-31T08:39:52.342722&#34;, 
    &#34;description&#34;: &#34;Dividends&#34;, 
    &#34;typ&#34;: &#34;TransactionType.INCOME&#34;
  }
]</code></pre></div>

<p><details>
  <summary>阮一峰: 远程通信的三代方法</summary>
    <blockquote class="twitter-tweet"><p lang="zh" dir="ltr">远程通信的三代方法<br><br>- 过去：SOAP ( HTTP + XML )<br>- 现在：REST ( HTTP + JSON )<br>- 未来：gRPC +  Protocol Buffers<a href="https://t.co/6SO6FZ8mhQ">https://t.co/6SO6FZ8mhQ</a></p>&mdash; ruanyf (@ruanyf) <a href="https://twitter.com/ruanyf/status/924517735832285184?ref_src=twsrc%5Etfw">October 29, 2017</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

</details></p>

<p>参考文档</p>

<blockquote>
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2011/09/restful.html">理解RESTful架构</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html">RESTful API 设计指南</a></li>
<li><a href="https://marshmallow.readthedocs.io/en/latest/why.html">Why marshmallow?</a></li>
<li><a href="https://github.com/kennethreitz/pipenv/issues/992">install marshmallow with flask failed with dep not resolved</a></li>
</ul>
</blockquote>

<p>封面图片来自 <a href="https://dribbble.com/shots/3389841-Rest-in-the-pool">Rest in the pool</a> <a href="https://dribbble.com/mihkonyev"><i class="fa fa-dribbble" aria-hidden="true"></i> Mihail Koniaiev</a></p>
         <div id="disqus_thread">
  <a href="#" onclick="disqus();return false;">enable VPN and click here to <i class="fa fa-comments" aria-hidden="true"></i></a>
</div>

<script type="text/javascript">
var disqus_loaded = false;
function disqus() {
  if (!disqus_loaded) {
    
    
    
    

    disqus_loaded = true;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'wushuzh';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
};
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</div>
<noscript>
  <style>.jsonly { display: none }</style>
</noscript>

          </div>
      </div>
  </div>
  <script src="https://wushuzh.github.io/js/jquery.min.js"></script>
<script src="https://wushuzh.github.io/js/bootstrap.min.js"></script>
<script src="https://wushuzh.github.io/js/jquery.cookie.js"> </script>
<script src="https://wushuzh.github.io/js/ekko-lightbox.js"></script>
<script src="https://wushuzh.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://wushuzh.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/owl.carousel.min.js"></script>
<script src="https://wushuzh.github.io/js/front.js"></script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
