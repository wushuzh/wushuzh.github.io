<!DOCTYPE html>
<html lang="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Flask 开发 2</title>
<meta name="description" content="个人技术站点">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://wushuzh.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://wushuzh.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.theme.css">


  <link href="https://wushuzh.github.io/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://wushuzh.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://wushuzh.github.io/img/favicon.png">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-102509506-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              
              
<div class="col-xs-12 col-sm-12 col-md-12 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="https://wushuzh.github.io/">小强会武术</a></h1>
</div>

  <div class="row">
    <div class="col-lg-10 col-lg-offset-1">
      <div class="content-column-content">
      
      <div class="row">
        <div class="col-sm-4">
          
            <div class="image">
              <img src="https://wushuzh.github.io//img/blog/a-dev-env-of-webapp-2/user-testing.gif" class="img-responsive" alt="">
            </div>
          
        </div>
        <div class="col-md-6">
            <h2>Flask 开发 2</h2>
                <p>
                  <i class="fa fa-share-square-o fa-fw"></i><a href="/"> 小强会武术</a>
                </p>

                <p>
                <time datetime="2017-11-14 22:47:09 &#43;0800 CST">
                <i class="fa fa-calendar-o fa-fw"></i> 2017-11-14
                </time>
                &middot;
                1229 字
                &middot;
                3 分钟
                </p>

                
                <p>
                  <i class="fa fa-tags fa-fw" aria-hidden="true"></i>
                  <a href="/tags/flask">flask</a>
                </p>
                

        </div>
      </div>
      <br />

         <p>集成容器数据库，为应用创建测试集</p>

<p>本系列是 <a href="https://testdriven.io/">Microservices with Docker, Flask, and React</a> 我的实践版——只要能达到相同效果，我会尝试替换更新原教程中的工具，升级版本，并简述填过或待填的坑。</p>

<h3 id="容器数据库">容器数据库</h3>

<p>引入 Postgresql DB 容器，通过在特定目录放入建库 SQL 脚本，为开发、测试、生产创建各自数据库。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">diff --git a/project/db/Dockerfile b/project/db/Dockerfile
new file mode 100644
index 0000000..5107468
<span style="color:#f92672">--- /dev/null
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/project/db/Dockerfile
</span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -0,0 +1,4 @@
</span><span style="color:#75715e"></span><span style="color:#a6e22e">+FROM postgres
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+# run create.sql on init
</span><span style="color:#a6e22e">+ADD create.sql /docker-entrypoint-initdb.d
</span><span style="color:#a6e22e"></span>diff --git a/project/db/create.sql b/project/db/create.sql
new file mode 100644
index 0000000..dc1815a
<span style="color:#f92672">--- /dev/null
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/project/db/create.sql
</span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -0,0 +1,3 @@
</span><span style="color:#75715e"></span><span style="color:#a6e22e">+CREATE DATABASE users_prod;
</span><span style="color:#a6e22e">+CREATE DATABASE users_dev;
</span><span style="color:#a6e22e">+CREATE DATABASE users_test;
</span></code></pre></div>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ cd db 
$ docker build -t users-db .</code></pre></div>

<p>在 compose yaml 中，原有的 users-service 需要与 DB 相连，故将其定义为“依赖”服务 users-db 。DB 初始化通常会花费一定时间，原教程中 depends_on 和 condition 连用的形式<a href="https://docs.docker.com/compose/compose-file/#depends_on">在 compose v3 中已不再支持</a>，按照 <a href="https://docs.docker.com/compose/startup-order/">Ctrl startup order in Compose</a> 的建议，我引入 wait-for-it 脚本判定后端启动时机，并使用 pg_isready 进行 db 服务的健康测试。其他更改和原教程相同: 将数据库连接串设定为环境变量和 project/config.py 配合使用。</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">diff --git a/docker-compose.yml b/docker-compose.yml
index 2369320..51972f9 100644
<span style="color:#f92672">--- a/docker-compose.yml
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/docker-compose.yml
</span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -1,6 +1,19 @@
</span><span style="color:#75715e"></span> version: &#34;3.2&#34;
 
 services:
<span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+    users-db:
</span><span style="color:#a6e22e">+        container_name: users-db
</span><span style="color:#a6e22e">+        # build: ./project/db
</span><span style="color:#a6e22e">+        image: users-db
</span><span style="color:#a6e22e">+        ports:
</span><span style="color:#a6e22e">+            - 5435:5432 # expose ports - HOST:CONTAINER
</span><span style="color:#a6e22e">+        environment:
</span><span style="color:#a6e22e">+            - POSTGRES_USER=postgres
</span><span style="color:#a6e22e">+            - POSTGRES_PASSWORD=postgres
</span><span style="color:#a6e22e">+        healthcheck:
</span><span style="color:#a6e22e">+            test: &#34;pg_isready -U postgres&#34;
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e"></span>     users-service:
         container_name: users-service
         #build: .
<span style="color:#75715e">@@ -14,3 +27,11 @@ services:
</span><span style="color:#75715e"></span>         environment:
             - FLASK_APP=project/__init__.py
             - APP_SETTINGS=project.config.DevelopmentConfig
<span style="color:#a6e22e">+            - DATABASE_URL=postgres://postgres:postgres@users-db:5432/users_dev
</span><span style="color:#a6e22e">+            - DATABASE_TEST_URL=postgres://postgres:postgres@users-db:5432/users_test
</span><span style="color:#a6e22e">+        depends_on:
</span><span style="color:#a6e22e">+            - users-db
</span><span style="color:#a6e22e">+        command: [&#34;./wait-for-it.sh&#34;, &#34;users-db:5432&#34;, &#34;-t&#34;, &#34;90&#34;, &#34;--&#34;, &#34;flask&#34;, &#34;run&#34;, &#34;-h&#34;, &#34;0.0.0.0&#34;]
</span><span style="color:#a6e22e">+        links:
</span><span style="color:#a6e22e">+            - users-db
</span><span style="color:#a6e22e">+
</span></code></pre></div>
<br /></p>

<h3 id="model-层">Model 层</h3>

<p>为当下虚拟环境添加负责 ORM 及 DBAPI 包:</p>

<ul>
<li>Flask-SQLAlchemy</li>
<li>psycopg2 <a href="http://docs.sqlalchemy.org/en/latest/core/engines.html#postgresql">SQLAlchemy PostgreSQL default API</a></li>
</ul>

<p>User 类中对表名和各 col 的详细定义</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">diff --git a/project/__init__.py b/project/__init__.py
index 45cd669..1f4d324 100644
<span style="color:#f92672">--- a/project/__init__.py
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/project/__init__.py
</span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -2,6 +2,8 @@
</span><span style="color:#75715e"></span> 
 import os
 from flask import Flask, jsonify
<span style="color:#a6e22e">+import datetime
</span><span style="color:#a6e22e">+from flask_sqlalchemy import SQLAlchemy
</span><span style="color:#a6e22e"></span> 
 # instantiate the app
 app = Flask(__name__)
<span style="color:#75715e">@@ -10,10 +12,39 @@ app = Flask(__name__)
</span><span style="color:#75715e"></span> app_settings = os.getenv(&#39;APP_SETTINGS&#39;)
 app.config.from_object(app_settings)
 
<span style="color:#a6e22e">+# instantiate the db
</span><span style="color:#a6e22e">+db = SQLAlchemy(app)
</span><span style="color:#a6e22e"></span> 
<span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+# model
</span><span style="color:#a6e22e">+class User(db.Model):
</span><span style="color:#a6e22e">+    __tablename__ = &#34;users&#34;
</span><span style="color:#a6e22e">+    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
</span><span style="color:#a6e22e">+    username = db.Column(db.String(128), nullable=False)
</span><span style="color:#a6e22e">+    email = db.Column(db.String(128), nullable=False)
</span><span style="color:#a6e22e">+    active = db.Column(db.Boolean(), default=False, nullable=False)
</span><span style="color:#a6e22e">+    created_at = db.Column(db.DateTime, nullable=False)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+    def __init__(self, username, email):
</span><span style="color:#a6e22e">+        self.username = username
</span><span style="color:#a6e22e">+        self.email = email
</span><span style="color:#a6e22e">+        self.created_at = datetime.datetime.utcnow()
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+# customer cmds
</span><span style="color:#a6e22e">+@app.cli.command()
</span><span style="color:#a6e22e">+def recreate_db():
</span><span style="color:#a6e22e">+    &#34;&#34;&#34;Recreates a database.&#34;&#34;&#34;
</span><span style="color:#a6e22e">+    db.drop_all()
</span><span style="color:#a6e22e">+    db.create_all()
</span><span style="color:#a6e22e">+    db.session.commit()
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+# routes
</span><span style="color:#a6e22e"></span> @app.route(&#39;/ping&#39;, methods=[&#39;GET&#39;])
 def ping_pong():
     return jsonify({
         &#39;status&#39;: &#39;success&#39;,
         &#39;message&#39;: &#39;pong!&#39;
     })
<span style="color:#a6e22e">+
</span></code></pre></div>

<p>重新打包最新 users-service 的镜像，启动各个服务，查看相关日志，并在 users-service 容器中执行重建库表的指令。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ docker build -t users-service \
    --build-arg https_proxy=ip:port \
    .
$ docker-compose up -d
Creating network &#34;users_default&#34; with the default driver
Creating users-db ... 
Creating users-db ... done
Creating users-service ... 
Creating users-service ... done

$ docker-compose logs -f
...
users-db      | PostgreSQL init process complete; ready for start up.
users-db      | ts: listening on IPv4 address &#34;0.0.0.0&#34;, port 5432
users-service | wait-for-it.sh: users-db:5432 is available after 83 seconds
...

$ curl http://$(docker-machine ip vdev):5001/ping 
{
  &#34;message&#34;: &#34;pong!&#34;, 
  &#34;status&#34;: &#34;success&#34;
}

$ docker-compose run users-service flask recreate_db
Starting users-db ... done
$ docker exec -ti $(docker ps -aqf &#34;name=users-db&#34;) psql -U postgres
psql (10.0)
Type &#34;help&#34; for help.

postgres=# \c users_dev
You are now connected to database &#34;users_dev&#34; as user &#34;postgres&#34;.
users_dev=# \dt
         List of relations
 Schema | Name  | Type  |  Owner   
--------+-------+-------+----------
 public | users | table | postgres
(1 row)

users_dev=# \q</code></pre></div>

<blockquote>
<p>测试至此，其实就可以关闭 ymal 中 ports 的配置了，这样后续 users-service 向 db-service 插入记录时才能通过 5432 端口连接</p>
</blockquote>

<h3 id="添加测试集">添加测试集</h3>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># project/tests/base.py</span>

<span style="color:#f92672">from</span> flask_testing <span style="color:#f92672">import</span> TestCase
<span style="color:#f92672">from</span> project <span style="color:#f92672">import</span> app, db


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseTestCase</span>(TestCase):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_app</span>(self):
        app<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>from_object(<span style="color:#e6db74">&#39;project.config.TestingConfig&#39;</span>)
        <span style="color:#66d9ef">return</span> app

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setUp</span>(self):
        db<span style="color:#f92672">.</span>create_all()
        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tearDown</span>(self):
        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>remove()
        db<span style="color:#f92672">.</span>drop_all()

<span style="color:#75715e"># /project/tests/test_users.py</span>

<span style="color:#f92672">import</span> json

<span style="color:#f92672">from</span> project.tests.base <span style="color:#f92672">import</span> BaseTestCase


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestUserService</span>(BaseTestCase):
    <span style="color:#e6db74">&#34;&#34;&#34;Tests for the Users Service.&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_users</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Ensure the /ping route behaves correctly.&#34;&#34;&#34;</span>
        response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;/ping&#39;</span>)
        data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(response<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>decode())
        self<span style="color:#f92672">.</span>assertEqual(response<span style="color:#f92672">.</span>status_code, <span style="color:#ae81ff">200</span>)
        self<span style="color:#f92672">.</span>assertIn(<span style="color:#e6db74">&#39;pong!&#39;</span>, data[<span style="color:#e6db74">&#39;message&#39;</span>])
        self<span style="color:#f92672">.</span>assertIn(<span style="color:#e6db74">&#39;success&#39;</span>, data[<span style="color:#e6db74">&#39;status&#39;</span>])


<span style="color:#75715e"># project/tests/test_config.py</span>

<span style="color:#f92672">import</span> unittest

<span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> current_app
<span style="color:#f92672">from</span> flask_testing <span style="color:#f92672">import</span> TestCase

<span style="color:#f92672">from</span> project <span style="color:#f92672">import</span> app


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestDevelopmentConfig</span>(TestCase):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_app</span>(self):
        app<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>from_object(<span style="color:#e6db74">&#39;project.config.DevelopmentConfig&#39;</span>)
        <span style="color:#66d9ef">return</span> app

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_app_is_developement</span>(self):
        self<span style="color:#f92672">.</span>assertTrue(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;my_precious&#39;</span>)
        self<span style="color:#f92672">.</span>assertTrue(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;DEBUG&#39;</span>] <span style="color:#f92672">is</span> True)
        self<span style="color:#f92672">.</span>assertFalse(current_app <span style="color:#f92672">is</span> None)
        self<span style="color:#f92672">.</span>assertTrue(
            app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style="color:#f92672">==</span>
            <span style="color:#e6db74">&#39;postgres://postgres:postgres@users-db:5432/users_dev&#39;</span>
        )</code></pre></div>

<p>compose 中指定应用的配置为 development，而我们可以通过测试重建各个环境下的 flask 应用并查看不同的配置是否生效。另外每次通过 curl 查看 ping 可以通过自动测试完成。</p>

<blockquote>
<p>我不得不在每次代码改动后都通过 docker cli 单独编译 image ，其实如果 bind mount 可以工作，是可以直接先行测试结果的。而且 docker-compose 也可以帮助编译，但我的 compose 中 build 选项却一直注释掉，主要是因为 image 安装新的软件包在出入编译时环境变量 (https_proxy) ，但 build 和 &ndash;build-arg 一切使用必须明确制定 service 名字，结果是 image 的名字被强行加入 project 前缀</p>
</blockquote>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ docker build -t users-service --build-arg https_proxy=ip:port .
...
# restart won&#39;t take new built image into account
$ docker-compose down 
$ docker-compose up -d

$ docker-compose run users-service flask test
Starting users-db ... done
test_app_is_developement (test_config.TestDevelopmentConfig) ... ok
test_app_is_production (test_config.TestProductionConfig) ... ok
test_app_is_testing (test_config.TestTestingConfig) ... ok
test_users (test_users.TestUserService)
Ensure the /ping route behaves correctly. ... ok

----------------------------------------------------------------------
Ran 4 tests in 0.349s

OK</code></pre></div>

<p>参考文档</p>

<blockquote>
<ul>
<li>Horst Gutmann (2017-09-02) <a href="https://zerokspot.com/weblog/2017/09/02/docker-healthchecks/">Docker Healthchecks</a></li>
<li><a href="https://docs.docker.com/compose/reference/run/">docker-compose run</a></li>
<li><a href="https://docs.docker.com/compose/reference/build/">docker-compose build</a></li>
</ul>
</blockquote>

<p>封面图片来自 <a href="https://dribbble.com/shots/3000461-User-Testing">User Testing</a> <a href="https://dribbble.com/asia-paczkowska"><i class="fa fa-dribbble" aria-hidden="true"></i> Asia Paczkowska</a></p>
         <div id="disqus_thread">
  <a href="#" onclick="disqus();return false;"> 点击启用 Disqus 评论文章 <i class="fa fa-comments" aria-hidden="true"></i></a>
</div>

<script type="text/javascript">
var disqus_loaded = false;
function disqus() {
  if (!disqus_loaded) {
    
    
    
    

    disqus_loaded = true;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'wushuzh';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
};
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</div>
<noscript>
  <style>.jsonly { display: none }</style>
</noscript>

          </div>
      </div>
  </div>
  <script src="https://wushuzh.github.io/js/jquery.min.js"></script>
<script src="https://wushuzh.github.io/js/bootstrap.min.js"></script>
<script src="https://wushuzh.github.io/js/jquery.cookie.js"> </script>
<script src="https://wushuzh.github.io/js/ekko-lightbox.js"></script>
<script src="https://wushuzh.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://wushuzh.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/owl.carousel.min.js"></script>
<script src="https://wushuzh.github.io/js/front.js"></script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
