<!DOCTYPE html>
<html lang="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>“调用”可视化</title>
<meta name="description" content="个人技术站点">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://wushuzh.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://wushuzh.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.theme.css">


  <link href="https://wushuzh.github.io/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://wushuzh.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://wushuzh.github.io/img/favicon.png">


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-102509506-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="https://wushuzh.github.io/">小强会武术</a></h1>
    
      <p class="sidebar-p">工程师</p>
    
      <p class="sidebar-p">记录每一个自己填平的坑</p>
    
    <ul class="sidebar-menu">
      
      
        <li><a href="https://wushuzh.github.io/blog/">Home</a></li>
      
    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/Xiao_Qiang" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  <a href="mailto:wushuzh@outlook.com" data-animate-hover="pulse" class="email">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  
  
  
  
  <a href="https://wushuzh.github.io/index.xml" data-animate-hover="pulse">
    <i class='fa fa-rss'></i>
  </a>
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2017 wushuzh
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="https://wushuzh.github.io/">小强会武术</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">
         
      <div class="row">
        <div class="col-sm-6">
          
            <div class="image">
              <img src="https://wushuzh.github.io//img/blog/draw-py-call-graph/schema.gif" class="img-responsive" alt="">
            </div>
          
        </div>
        <div class="col-md-6">
            <h2>“调用”可视化</h2>
                <p>
                  小强会武术
                </p>

                <time datetime="2017-11-24 11:37:35 &#43;0800 CST">
                <i class="fa fa-calendar-o fa-fw"></i> 2017-11-24
                </time>
                &middot;
                1003 字
                &middot;
                3 分钟

        </div>
      </div>
      <br />

         <p>追踪代码调用，生成 call grapy
</p>

<h3 id="代码覆盖">代码覆盖</h3>

<p>前几天听了 Ned Batchelder (Coverage.py 的维护者）的<a href="https://www.podcastinit.com/coverage-py-with-ned-batchelder-episode-121/">访谈</a>，也提到了 trace 模块可以用来跟踪代码执行覆盖情况。于是从网上找到两篇介绍追踪呈现方法调用关系的文章，见文末参考文档</p>

<p>首先写一个被测函数 f，并使用 unittest 对 f 的不同的输入类型和处理分支写测试用例。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>(a):
    <span style="color:#66d9ef">if</span> a <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">return</span> a
    <span style="color:#66d9ef">elif</span> a <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>()
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>a
<span style="color:#75715e"># end of coverage</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    <span style="color:#f92672">import</span> unittest

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestFuncF</span>(unittest<span style="color:#f92672">.</span>TestCase):
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_int</span>(self):
            self<span style="color:#f92672">.</span>assertEqual(<span style="color:#ae81ff">3</span>, f(<span style="color:#ae81ff">3</span>))
            self<span style="color:#f92672">.</span>assertEqual(<span style="color:#ae81ff">3</span>, f(<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>))

        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_float</span>(self):
            self<span style="color:#f92672">.</span>assertEqual(<span style="color:#ae81ff">3.0</span>, f(<span style="color:#ae81ff">3.0</span>))
            self<span style="color:#f92672">.</span>assertEqual(<span style="color:#ae81ff">3.0</span>, f(<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0</span>))</code></pre></div>

<p>下一步，在 trace 框架下运行<a href="https://docs.python.org/3/library/unittest.html#unittest.main">测试用例</a>，运行结束后获取跟踪结果: 从复杂的 <a href="https://docs.python.org/3/library/trace.html#trace.CoverageResults">trace.CoverageResults</a> 中提取出各行代码运行次数，转存到 <a href="https://docs.python.org/3/library/collections.html#defaultdict-objects">defaultdict</a> 中，因此其值一定是 int 。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#f92672">import</span> trace

    t <span style="color:#f92672">=</span> trace<span style="color:#f92672">.</span>Trace(count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, trace<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
    t<span style="color:#f92672">.</span>runfunc(unittest<span style="color:#f92672">.</span>main, exit<span style="color:#f92672">=</span>False)
    r <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>results()

    <span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict

    linecount <span style="color:#f92672">=</span> defaultdict(int)
    <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>counts:
        <span style="color:#75715e">#    line[0]     line[1]</span>
        <span style="color:#75715e"># { (&#39;srcfile1&#39;, lineno): count, ... }</span>
        <span style="color:#66d9ef">if</span> line[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> __file__:
            linecount[line[<span style="color:#ae81ff">1</span>]] <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>counts[line]</code></pre></div>

<p>最后读取当前文件源码，找到函数 f 的各行代码执行次数并打印。这样就会发现有一个重要的分支没有覆盖到。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#f92672">from</span> re <span style="color:#f92672">import</span> compile, match

    eoc <span style="color:#f92672">=</span> compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;^\s*# end of coverage&#39;</span>)
    <span style="color:#66d9ef">with</span> open(__file__) <span style="color:#66d9ef">as</span> f:
        <span style="color:#66d9ef">for</span> linenumber, line <span style="color:#f92672">in</span> enumerate(f, start<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
            <span style="color:#66d9ef">if</span> eoc<span style="color:#f92672">.</span>match(line): <span style="color:#66d9ef">break</span>
            <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;{linecount[linenumber]:02} {line}&#34;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)</code></pre></div>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">..
-------------------------------------------
Ran 2 tests in 0.002s

OK
00 def f(a):
04     if a &gt; 0:
02         return a
02     elif a == 0:
00         raise ValueError()
02     return -a</code></pre></div>

<h3 id="调用关系">调用关系</h3>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>():
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
        g(i)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">g</span>(n):
    <span style="color:#66d9ef">return</span> h(n) <span style="color:#f92672">+</span> i(n)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">h</span>(n):
    <span style="color:#66d9ef">return</span> n <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">i</span>(n):
    <span style="color:#66d9ef">return</span> n <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    <span style="color:#f92672">import</span> trace
    
    t <span style="color:#f92672">=</span> trace<span style="color:#f92672">.</span>Trace(count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, trace<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, countfuncs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, countcallers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    t<span style="color:#f92672">.</span>runfunc(f)
    r <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>results()
    <span style="color:#66d9ef">print</span>(dir(r))
    <span style="color:#66d9ef">print</span>(r<span style="color:#f92672">.</span>callers)</code></pre></div>

<p>上面跟踪了函数逐条语句执行情况，我们还可以通过向 Trace 传入其他各种开关跟踪函数调用情况。这样产生的 CoverageResults 对象的 key 也会包含不同粒度对象的调用情况。CoverageResults 的类型貌似总是 dict，其值也总为被调用次数。而 key 就因情况而异了，本例中为 tuple of tuples，第一层 tuple 为 (caller, callee) ，然后 caller 和 callee 又都为 tuple 起组成为 (filename, module, funcname)</p>

<blockquote>
<p>python 一直以文档完善而著称，但关于 trace 模块的文档却不是很详尽，你需要使用 python 的各种自省查看其内部的数据结构。这种不详尽的主要原因可能是因为只有资深开发者会使用这个模块追踪代码调用情况。或者其数据结构仍可能在未来变化?</p>
</blockquote>

<h3 id="jsplumb">JSPlumb</h3>

<p>这个 JS 库主要用于连接各种元素，其基础概念有</p>

<ul>
<li>Anchor 用户无法自行创建，但它标识了某一元素的 Endpoints 可存在的位置</li>
<li>Endpoint 代表一个连接(Connection) 的某一端</li>
<li>Connector 代表一个连接两个元素的连线</li>
<li>Overlay 可用于装饰连线(Connector)，比如箭头、文本框</li>
<li>Connection = Endpoint + Connector + Endpoint + Overlay</li>
</ul>

<p>API 都暴露在 Connection 和 Endpoint 上，但你最终需要通过它们调整 Anchor, Connector 和 Overlay。</p>

<p>相比 nodejs 官方的 npm 工具，更推荐使用 Facebook 出品的包管理工具 yarn :</p>

<ul>
<li>速度快</li>
<li>去除不不必要的选项、指令短</li>
<li>支持缓存离线安装</li>
</ul>

<blockquote>
<p>bower 项目已经停止。</p>
</blockquote>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ pacman -Q nodejs npm
nodejs 9.2.0-1
npm 5.5.1-2

$ pacman -Ss yarn
community/yarn 1.3.2-1
    Fast, reliable, and secure dependency management
$ pacman -S yarn

$ yarn config set proxy http://ip:port
$ yarn config set https-proxy http://ip:port

$ yarn info jsplumb
$ yarn add jsplumb</code></pre></div>

<p>参考文档</p>

<blockquote>
<ul>
<li>Michel J. Anders

<ul>
<li>(2011-05-01) <a href="http://michelanders.blogspot.fi/2011/05/coverage-testing-in-python-combining.html">Coverage Testing in Python: Combining the unittest and trace Modules</a></li>
<li>(2011-05-29) <a href="http://michelanders.blogspot.fi/2011/05/visualizing-python-call-graphs-with.html">Visualizing Python Call Graphs With Jsplumb</a></li>
</ul></li>
<li>Dilinl Mampitiya (2016-03-04) <a href="https://dilinimampitiya.wordpress.com/2016/03/04/implement-a-flowchart-editor-using-jsplumb-part-1/">Implement a Flowchart Editor using jsPlumb – Part 1</a></li>
<li>Free Dev Tutorials <a href="http://www.freedevelopertutorials.com/jsplumb-tutorial/">jsPlumb Tutorial</a></li>
<li>Real Python (2014-05-03) <a href="https://realpython.com/blog/python/primer-on-jinja-templating/">Primer on Jinja Templating</a></li>
<li><a href="https://www.youtube.com/playlist?list=PLC3y8-rFHvwhgWwm5J3KqzX47n7dwWNrq">npm Tutorial for Beginners</a></li>
<li><a href="http://www.jhipster.tech/configuring-a-corporate-proxy/">Configuring a corporate proxy</a></li>
<li><a href="https://www.udacity.com/wiki/creating-network-graphs-with-python">Creating Network Graphs with Python</a></li>
</ul>
</blockquote>

<p>封面图片来自 <a href="https://dribbble.com/shots/2235198-Information-design-Theatre-Personal-project-WIP">Information design</a> <a href="https://dribbble.com/federicafragapane"><i class="fa fa-dribbble" aria-hidden="true"></i> Federica Fragapane</a></p>
         <div id="disqus_thread">
  <a href="#" onclick="disqus();return false;">enable VPN and click here to <i class="fa fa-comments" aria-hidden="true"></i></a>
</div>

<script type="text/javascript">
var disqus_loaded = false;
function disqus() {
  if (!disqus_loaded) {
    
    
    
    

    disqus_loaded = true;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'wushuzh';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
};
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</div>
<noscript>
  <style>.jsonly { display: none }</style>
</noscript>

          </div>
      </div>
  </div>
  <script src="https://wushuzh.github.io/js/jquery.min.js"></script>
<script src="https://wushuzh.github.io/js/bootstrap.min.js"></script>
<script src="https://wushuzh.github.io/js/jquery.cookie.js"> </script>
<script src="https://wushuzh.github.io/js/ekko-lightbox.js"></script>
<script src="https://wushuzh.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://wushuzh.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/owl.carousel.min.js"></script>
<script src="https://wushuzh.github.io/js/front.js"></script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
