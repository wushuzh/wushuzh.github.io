<!DOCTYPE html>
<html lang="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Flask 教程2</title>
<meta name="description" content="个人技术站点">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://wushuzh.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://wushuzh.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://wushuzh.github.io/css/owl.theme.css">


  <link href="https://wushuzh.github.io/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://wushuzh.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://wushuzh.github.io/img/favicon.png">


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-102509506-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              
              
<div class="col-xs-12 col-sm-12 col-md-12 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="https://wushuzh.github.io/">小强会武术</a></h1>
</div>

  <div class="row">
    <div class="col-lg-10 col-lg-offset-1">
      <div class="content-column-content">
      
      <div class="row">
        <div class="col-sm-4">
          
            <div class="image">
              <img src="https://wushuzh.github.io//img/blog/dev-db-model-in-flask/db.png" class="img-responsive" alt="">
            </div>
          
        </div>
        <div class="col-md-6">
            <h2>Flask 教程2</h2>
                <p>
                  <i class="fa fa-share-square-o fa-fw"></i><a href="/"> 小强会武术</a>
                </p>

                <p>
                <time datetime="2018-01-30 21:17:49 &#43;0800 CST">
                <i class="fa fa-calendar-o fa-fw"></i> 2018-01-30
                </time>
                &middot;
                1344 字
                &middot;
                3 分钟
                </p>

                
                <p>
                  <i class="fa fa-tags fa-fw" aria-hidden="true"></i>
                  <a href="/tags/flask">flask</a>
                </p>
                

        </div>
      </div>
      <br />

         <p>flask 教程: 创建一个类微博原型站点
</p>

<h2 id="数据库工作流程">数据库工作流程</h2>

<p>Flask 并不含对任何特定数据库的原生支持，开发者根据自身需求安装相应拓展进行自由选择。</p>

<p>这里选用的 flask 拓展是 Flask-SQLAlchemy —— 作为 python 对象和关系数据库记录的中继层。另一个 flask 拓展是 flask-migrate —— 它可以为开发过程中各种数据定义的变更保驾护航。</p>

<p>安装好拓展后，先在配置模块中添加本地开发使用的 sqlite 数据库的配置信息，然后再为 SQLAlchemy 和 Migrate 创建各自实例 —— 基本上所有 flask 的拓展都使用类似方式完成初始化。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># filename: config.py</span>
<span style="color:#f92672">import</span> os
basedir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(__file__))


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Config</span>(object):
    <span style="color:#75715e"># get SECRET_KEY from env or default hardcoded value</span>
    SQLALCHEMY_DATABASE_URI <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;DATABASE_URL&#39;</span>) <span style="color:#f92672">or</span> \
        <span style="color:#e6db74">&#39;sqlite:///&#39;</span> <span style="color:#f92672">+</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(basedir, <span style="color:#e6db74">&#39;app.db&#39;</span>)
    SQLALCHEMY_TRACK_MODIFICATIONS <span style="color:#f92672">=</span> False


<span style="color:#75715e"># filename: app/__init__.py</span>

<span style="color:#75715e"># import ...</span>
<span style="color:#f92672">from</span> flask_sqlalchemy <span style="color:#f92672">import</span> SQLAlchemy
<span style="color:#f92672">from</span> flask_migrate <span style="color:#f92672">import</span> Migrate

app <span style="color:#f92672">=</span> Flask(__name__)
app<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>from_object(Config)
db <span style="color:#f92672">=</span> SQLAlchemy(app)
migrate <span style="color:#f92672">=</span> Migrate(app, db)

<span style="color:#f92672">from</span> app <span style="color:#f92672">import</span> routes, models</code></pre></div>

<p>新建一个模块名为 models ，首先定义 User :</p>

<ul>
<li>表主键 id 由数据库自动分配;</li>
<li>保存用户名，类型字符串，需保证唯一同时做索引;</li>
<li>保存用户邮箱，和用户名类似需求，只是长度更长;</li>
<li>保存密码的散列，为了安全，要将密码散列为定长字符存储;</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># filename: app/models.py</span>
<span style="color:#f92672">from</span> app <span style="color:#f92672">import</span> db

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(db<span style="color:#f92672">.</span>Model):
    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span>True)
    username <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">64</span>), index<span style="color:#f92672">=</span>True, unique<span style="color:#f92672">=</span>True)
    email <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">120</span>), index<span style="color:#f92672">=</span>True, unique<span style="color:#f92672">=</span>True)
    password_hash <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">128</span>))

    <span style="color:#66d9ef">def</span> __repr__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&lt;User {}&gt;&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>username)</code></pre></div>

<p>所有字段作为 User 类的类变量，本质都是由代表每列各自属性的不同参数的 db.Column 类的实例化对象。</p>

<p>数据库方面分三步走:</p>

<ul>
<li>初始化指令(init) 为数据库的相关脚本准备基本目录结构;</li>
<li>迁移指令(migrate) 会结合当前 models 代码和数据库实际情况准备好升级、降级脚本;</li>
<li>升降指令(upgrade) 才真正地在库表上执行变更操作;</li>
</ul>

<blockquote>
<p>注意 MySQL 和 PostgreSQL 比 sqlite 复杂的地方在于，我们需要在执行 upgrade 之前创建数据库。</p>
</blockquote>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">(venv) [microblog-flask]$ flask db init
  Creating directory /p/microblog-flask/migrations ... done
  Creating directory /p/microblog-flask/migrations/versions ... done
  Generating /p/microblog-flask/migrations/script.py.mako ... done
  Generating /p/microblog-flask/migrations/alembic.ini ... done
  Generating /p/microblog-flask/migrations/README ... done
  Generating /p/microblog-flask/migrations/env.py ... done
  Please edit configuration/connection/logging settings in &#39;/p/microblog-flask/migrations/alembic.ini&#39; before proceeding.

(venv) [microblog-flask]$ flask db migrate -m &#34;users table&#34;
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table &#39;user&#39;
INFO  [alembic.autogenerate.compare] Detected added index &#39;ix_user_email&#39; on &#39;[&#39;email&#39;]&#39;
INFO  [alembic.autogenerate.compare] Detected added index &#39;ix_user_username&#39; on &#39;[&#39;username&#39;]&#39;
  Generating /p/microblog-flask/migrations/versions/398e0b87f3af_users_table.py ... done

(venv) [microblog-flask]$ flask db upgrade
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -&gt; 398e0b87f3af, users table</code></pre></div>

<h2 id="模型关系">模型关系</h2>

<p>下面引入的另一个对微博的模型 Post ，除了常规的内部唯一 ID 标识，内容，发布时间，还有一个用于标识发帖用户的外键。</p>

<p>这里的模型关系是一个典型 1 对 n 的关系: 一个用户可以发多个帖子。</p>

<ul>
<li>在原有 User 模型(关系中的1)中，用 <code>db.relationship</code> 定义一个虚拟字段 posts: 这样实际访问 (关系中的n) 时会比较方便;</li>
<li>参数 backref 则是标识了通过 Post 对象(关系中的n)访问 User 对象时使用的虚拟字段;</li>
<li>新建 Post 模型中定义时间戳字段，传入 default 的参数为函数引用，SQLAlchemy 就可以在实例化 Post 时代为调用该函数;</li>
<li>最后 Post 模型中的 user_id 字段是一个数据库实际字段，将借用 User 表中 id 字段，同时作为 Post 模型的外键。</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> app <span style="color:#f92672">import</span> db
<span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(db<span style="color:#f92672">.</span>Model):
    <span style="color:#75715e"># previous defined fields</span>
    posts <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>relationship(<span style="color:#e6db74">&#39;Post&#39;</span>, backref<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;author&#39;</span>, lazy<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dynamic&#39;</span>)

    <span style="color:#75715e"># __repr__</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Post</span>(db<span style="color:#f92672">.</span>Model):
    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span>True)
    body <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">140</span>))
    timestamp <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>DateTime, index<span style="color:#f92672">=</span>True, default<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow)
    user_id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, db<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#39;user.id&#39;</span>))

    <span style="color:#66d9ef">def</span> __repr__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&lt;Post {}&gt;&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>body)</code></pre></div>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">(venv) [microblog-flask]$ flask db migrate -m &#34;posts table&#34;
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table &#39;post&#39;
INFO  [alembic.autogenerate.compare] Detected added index &#39;ix_post_timestamp&#39; on &#39;[&#39;timestamp&#39;]&#39;
  Generating /p/microblog-flask/migrations/versions/fceea7a95e54_posts_table.py ... done

(venv) [microblog-flask]$ flask db upgrade
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 398e0b87f3af -&gt; fceea7a95e54, posts table</code></pre></div>

<h2 id="后端调试">后端调试</h2>

<p>在 python 终端导入数据库和 User、Post 模型。创建 2 个用户和 1 个帖子。
&gt; 注意新建帖子的代码，只需给出反向引用的 author 对象，SQLAlchemy 会自动从中提取 user.id</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pycon" data-lang="pycon">&gt;&gt;&gt; from app import db
&gt;&gt;&gt; from app.models import User, Post
&gt;&gt;&gt;
&gt;&gt;&gt; u = User(username=&#39;john&#39;, email=&#39;j@e.c&#39;)
&gt;&gt;&gt; db.session.add(u)
&gt;&gt;&gt; db.session.add(User(username=&#39;susan&#39;, email=&#39;s@e.com&#39;))
&gt;&gt;&gt; db.session.commit()
&gt;&gt;&gt;
&gt;&gt;&gt; User.query.all()
[&lt;User john&gt;, &lt;User susan&gt;]
&gt;&gt;&gt; u = User.query.get(1)
&gt;&gt;&gt; u
&lt;User john&gt;
&gt;&gt;&gt; u.email
&#39;j@m.c&#39;
&gt;&gt;&gt;
&gt;&gt;&gt; p = Post(body=&#39;first post&#39;, author=u)
&gt;&gt;&gt; db.session.add(p)
&gt;&gt;&gt; db.session.commit()
&gt;&gt;&gt; u.posts.all()
[&lt;Post first post&gt;]
&gt;&gt;&gt; p.author.email
&#39;j@m.c&#39;
&gt;&gt;&gt;
&gt;&gt;&gt; users = User.query.all()
&gt;&gt;&gt; for u in users:
...   db.session.delete(u)
...
&gt;&gt;&gt; posts = Post.query.all()
&gt;&gt;&gt; for p in posts:
...   db.session.delete(p)
...
&gt;&gt;&gt; db.session.commit()
&gt;&gt;&gt; User.query.all()
[]
&gt;&gt;&gt; Post.query.all()
[]
&gt;&gt;&gt;</code></pre></div>

<p>flask 提供了另一个核心命令 <code>shell</code>，使开发者能进入直接带有预定义导入的类变量方便调试。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># filename: microblog.py</span>
<span style="color:#f92672">from</span> app <span style="color:#f92672">import</span> app, db
<span style="color:#f92672">from</span> app.models <span style="color:#f92672">import</span> User, Post


<span style="color:#a6e22e">@app.shell_context_processor</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_shell_context</span>():
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;db&#39;</span>: db, <span style="color:#e6db74">&#39;User&#39;</span>: User, <span style="color:#e6db74">&#39;Post&#39;</span>: Post}</code></pre></div>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-pycon" data-lang="pycon">(venv) [microblog-flask]$ export FLASK_APP=microblog.py
(venv) [microblog-flask]$ flask shell
Python 3.6.3 (default, Oct 24 2017, 14:48:20)
[GCC 7.2.0] on linux
App: app
Instance: /p/microblog-flask/instance
&gt;&gt;&gt; db
&lt;SQLAlchemy engine=sqlite:////p/microblog-flask/app.db&gt;
&gt;&gt;&gt; User
&lt;class &#39;app.models.User&#39;&gt;
&gt;&gt;&gt; Post
&lt;class &#39;app.models.Post&#39;&gt;
&gt;&gt;&gt;</code></pre></div>

<p>参考文档</p>

<p>Miguel Grinberg</p>

<blockquote>
<ul>
<li>(2017-12-27) <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world">The Flask Mega-Tutorial Part Ⅳ: Database</a></li>
</ul>
</blockquote>

<p>封面图片来自 <a href="https://dribbble.com/shots/3045907-Conquering-SQL">Conquering SQL</a> <a href="https://dribbble.com/DaytimeAV"><i class="fa fa-dribbble" aria-hidden="true"></i> AV</a></p>
         <div id="disqus_thread">
  <a href="#" onclick="disqus();return false;"> 点击启用 Disqus 评论文章 <i class="fa fa-comments" aria-hidden="true"></i></a>
</div>

<script type="text/javascript">
var disqus_loaded = false;
function disqus() {
  if (!disqus_loaded) {
    
    
    
    

    disqus_loaded = true;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'wushuzh';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
};
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</div>
<noscript>
  <style>.jsonly { display: none }</style>
</noscript>

          </div>
      </div>
  </div>
  <script src="https://wushuzh.github.io/js/jquery.min.js"></script>
<script src="https://wushuzh.github.io/js/bootstrap.min.js"></script>
<script src="https://wushuzh.github.io/js/jquery.cookie.js"> </script>
<script src="https://wushuzh.github.io/js/ekko-lightbox.js"></script>
<script src="https://wushuzh.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://wushuzh.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://wushuzh.github.io/js/owl.carousel.min.js"></script>
<script src="https://wushuzh.github.io/js/front.js"></script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</body>
</html>
