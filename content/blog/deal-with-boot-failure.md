+++
date = "2017-07-19T18:45:13+08:00"
title = "启动错误，咋整？"
showonlyimage = false
image = "/img/blog/deal-with-boot-failure/disk-err.png"
topImage = "/img/blog/deal-with-boot-failure/disk-err.gif"
draft = false
weight = 43
tags = [ "Howto", "Storage", "Linux" ]
+++

记录下最近和启动、存储相关的修复处理。
<!--more-->

为了说明提供长期可靠存储的困难，先和大家一起回忆一下 《三体 Ⅲ 死神永生》尾声的一个片段  

- 故事背景：程圣母带领人类痛失威慑纪元……但勤劳勇敢的地球人不屈不挠，抱着死也要拉个垫背的坚强信念，利用最后的引力波向全宇宙大喊出了三体星系的祖坟位置……  
- 掩体纪元：三体星系的祖坟如约被刨，但对太阳系的黑暗森林打击也紧随而至……

<img alt="三体 Ⅲ 死神永生" src="/img/blog/deal-with-boot-failure/santi-3.jpg" class="img-responsive">

* 谈话地点：冥王星地球文明博物馆
* 谈话人物：罗辑、程心等
* 谈话重点：罗辑介绍了在这里这么苦逼的为人类文明刻碑，就是因为信息对不同的介质，存储的效率和时限不能兼得

1. 普通量子存储器 500 年
2. U盘和硬盘 5000 年
3. 特殊金属光盘 10 万年
4. 特种合成纸张和油墨 20 万年

科学家团队最终确认了将信息保存一亿年的唯一可行方法。大概是因为得到这个结论还花了不少经费，所以宣布的时候多少还些点扭捏：**“ 把字都刻在石头上 ”**

回到现实，大概最日常硬件故障就是磁盘损坏。

当下很火热的大数据应用，普遍都是将数据做分布式的冗余存储 ( 如 HDFS )。而就算那些非大数据应用，无论是系统的生产环境部署，或对重要数据的存储也都会做硬/软件的 RAID ，以便提供更好的数据可靠性和冗余度。比如在主板上集成或外加一块扩展卡（比如 HP 410i），或使用外置存储(如 HP P2000 和 MSA ) 上的存储控制器，将多块物理磁盘按 RAID1，RAID5 等方式组合为一个逻辑磁盘后，再对外服务。此种模式下更新一块坏盘就很容易。不开箱直接插拔问题磁盘即可，更新后，硬件存储控制器会自动将原有数据按冗余设置在新盘上同步好，无需人工干预。

但这些都仅限于实验室的日常维护，而下面的问题都是来自服务器迁移——换机房后发生的。

### 案例 1 连线错误

问题描述：上电后，服务器进不去操作系统，一直显示从 C 盘启动。
```
Attempting Boot From Hard Drive (C:)
```
眼见为实，进入机房，先确认、查看服务器的位置和连线情况:

- 服务器前面板 12 块内置磁盘
- 服务器后背板连出一条 SAS 线
- 此 SAS 线外接到一存储阵列( 含另 12 块磁盘 )背板上，连线处有人为标记的红点
  ( 此为工程实践：搬家前先打点，可在背板众多接口中方便地找出原接线位置 )

连上显示器和键盘，重置服务器，做问题重现：

- P410i 自检时，有多个逻辑盘，但要求用户确认磁盘情况 (F2)
- P411 自检时，却是 0 个逻辑盘

诊断服务器背板的 SAS 连线错误：搬家前仅在存储阵列的背板接口上标记了红点，但连线另一端的服务器背板的接口处却没打，所以将本该连在 P411 控制卡上的 SAS 线，错误的连接到了 P410i 上面( P410i 可以通过机箱内部管理内置的磁盘，而且还可以通过 SAS 连线再管理一个外置存储阵列。)，导致无法启动。之后重现连线后，系统启动正常。

### 案例 2 控制器启动顺序

问题描述：上电后，服务器进不去操作系统，一直显示从 C 盘启动。

服务器基本情况：

-  1 * Smart Array P410i Controller 管理其自带 12 块磁盘；
-  1 * Smart Array P411 Controller 管理外置存储上另 12 块磁盘；

这是几年前我搭建的一个虚拟机的宿主服务器。当时设计的是

- P410i 选 2 块磁盘，按 RAID 1 组成一个逻辑分区，存放 OS ，包括根分区、软件、系统日志、swap 等
- P410i 将余下 10 块磁盘，按 RAID 5 组成一个逻辑分区，存放自家产品的 daily build iso
- P411 将外置 12 块磁盘，按 RAID 50 做成一块逻辑分区，存放创建虚拟机的 QCOW2 文件

连上显示器和键盘，重置服务器，做问题重现：

自检时，分别进入 P410i 和 P411 阵列控制器配置界面，确认当下的各个逻辑分区和之前的规划一致。当前 BIOS 设置为 P410i 先，P411 后，但仍然 bootloader 时依然显示试图从 C 盘启动，挂死。再次重置服务器，这回 BIOS 设置为 P411 先，P410i 后，终于成功进入系统。

很反直觉的设置，集成的存储阵列控制器 P410i 要后于扩展的控制器 P411 启动。这大概是当时安装系统的时候，继承了之前的反常规配置而没有调整，导致现在 boot 时磁盘初始化顺序必须保持原样才能启动。遇到搬家这种情况，一切按照常理推断，总将 P410i 先于 P411 启动，必然出问题。

> 不知道有没有什么更改和补救措施改进这个顺序问题。可以继续深挖 TODO

案例 3 见下篇 [磁盘错误，咋整？]({{< relref "blog/deal-with-disk-error.md" >}})

## 结论

本次实验室服务器迁移，相关同事已经做了详细的计划和准备，包括下架顺序，上架位置规划，新网段地址的预先排布。整体迁移的过程已经算是很顺利了，但仍有几台服务器上电后出现问题。这些记录的问题，貌似和启动相关，其实它们都是一些除网线外，仍需和如外部磁盘阵列等连接的机器，不用说这些存储中有团队需要继续使用的数据，丢失会造成重大损失。所以对它们的迁移要做更完善的准备，比如迁移前要做一次重启操作，把 BIOS ，SmartArray Controller 的信息备份或是记录下来，对连线的接口作打点，讲每个一连线的始端、终端全部拍照。

遇到问题首先找出机器迁移前备份出来的所有原始资料，做无差变的连线和数据复原：无路 SAS 还是光纤要得和原来的接法一致，查看自检过程中每个设备的数据信息，将每个出现的异常都妥善处理好，最后才有可能重新启动系统。

如果关于自检、内核载入、服务启动的过程和原理有比较清晰的了解的话，对于定位问题，做合适的措施也会很有帮助——另外还有一台连了 4 个外接阵列的服务器的恢复过程在下篇记录。

封面图片来自 [Lisa](https://dribbble.com/shots/3371975-Lisa) <a href="https://dribbble.com/Johannes_Fast"><i class="fa fa-dribbble" aria-hidden="true"></i> Johannes Fast</a>  
